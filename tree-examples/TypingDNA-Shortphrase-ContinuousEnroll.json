
{
  "origin": "027ccb72ca3dda4b18c95bbf44873714 -",
  "innernodes": {
    "0d9562c1-be82-4a4e-9823-ad52adfffa7f": {
      "_id": "0d9562c1-be82-4a4e-9823-ad52adfffa7f",
      "_type": {
        "_id": "UsernameCollectorNode",
        "name": "Username Collector",
        "collection": true
      }
    },
    "42993513-5a9e-4762-9a8c-ef6437e29cd3": {
      "_id": "42993513-5a9e-4762-9a8c-ef6437e29cd3",
      "_type": {
        "_id": "PasswordCollectorNode",
        "name": "Password Collector",
        "collection": true
      }
    },
    "c0eac671-f8fc-4d9d-a6bc-192ed9c97eb9": {
      "_id": "c0eac671-f8fc-4d9d-a6bc-192ed9c97eb9",
      "textToEnter": "I am authenticated by the way I type",
      "_type": {
        "_id": "TypingDNAShortPhraseCollector",
        "name": "TypingDNA Short Phrase Collector",
        "collection": true
      }
    },
    "c53c1c93-bcfe-431b-a768-31ed5c972a42": {
      "_id": "c53c1c93-bcfe-431b-a768-31ed5c972a42",
      "showVisualizer": true,
      "displayMessage": true,
      "script": "42e487f5-33c1-4775-a5dc-56b76041e978",
      "disableCopyAndPaste": true,
      "_type": {
        "_id": "TypingDNARecorder",
        "name": "TypingDNA Recorder",
        "collection": true
      }
    }
  },
  "nodes": {
    "13b0504e-e6fe-4087-ae86-dc534e509aac": {
      "_id": "13b0504e-e6fe-4087-ae86-dc534e509aac",
      "nodes": [
        {
          "_id": "0d9562c1-be82-4a4e-9823-ad52adfffa7f",
          "nodeType": "UsernameCollectorNode",
          "displayName": "Username Collector"
        },
        {
          "_id": "42993513-5a9e-4762-9a8c-ef6437e29cd3",
          "nodeType": "PasswordCollectorNode",
          "displayName": "Password Collector"
        }
      ],
      "_type": {
        "_id": "PageNode",
        "name": "Page Node",
        "collection": true
      }
    },
    "44985fef-76b3-46b2-a029-9e4709cacaa1": {
      "_id": "44985fef-76b3-46b2-a029-9e4709cacaa1",
      "nodes": [
        {
          "_id": "c0eac671-f8fc-4d9d-a6bc-192ed9c97eb9",
          "nodeType": "TypingDNAShortPhraseCollector",
          "displayName": "TypingDNA Short Phrase Collector"
        },
        {
          "_id": "c53c1c93-bcfe-431b-a768-31ed5c972a42",
          "nodeType": "TypingDNARecorder",
          "displayName": "TypingDNA Recorder"
        }
      ],
      "_type": {
        "_id": "PageNode",
        "name": "Page Node",
        "collection": true
      }
    },
    "90f2e5c8-7f47-4f5b-975b-9b4762c5e4e7": {
      "_id": "90f2e5c8-7f47-4f5b-975b-9b4762c5e4e7",
      "_type": {
        "_id": "DataStoreDecisionNode",
        "name": "Data Store Decision",
        "collection": true
      }
    },
    "ec7c3bb9-9bbf-453a-928d-243dca1f5a01": {
      "_id": "ec7c3bb9-9bbf-453a-928d-243dca1f5a01",
      "retries": 1,
      "matchScore": 70,
      "apiKey": "",
      "apiUrl": "https://api.typingdna.com",
      "usernameSalt": "salt",
      "enrollmentsNecessary": 2,
      "requestIdentifier": "tdna-shortphrase-enroll",
      "apiSecret": "",
      "autoEnrollScore": 90,
      "requestTimeout": 8000,
      "verifyAfterEnroll": false,
      "_type": {
        "_id": "TypingDNADecisionNode",
        "name": "TypingDNA Decision Node",
        "collection": true
      }
    }
  },
  "scripts": {
    "42e487f5-33c1-4775-a5dc-56b76041e978": {
      "_id": "42e487f5-33c1-4775-a5dc-56b76041e978",
      "name": "TypingDNA",
      "description": "",
      "script": "LyoqCiAqIFR5cGluZ0ROQSAtIFR5cGluZyBCaW9tZXRyaWNzIEphdmFTY3JpcHQgQVBJCiAqIGh0dHBzOi8vd3d3LnR5cGluZ2RuYS5jb20vc2NyaXB0cy90eXBpbmdkbmEuanMKICogaHR0cHM6Ly9hcGkudHlwaW5nZG5hLmNvbS9zY3JpcHRzL3R5cGluZ2RuYS5qcyAoYWx0ZXJuYXRpdmUpCiAqCiAqIEdpdEh1YiByZXBvc2l0b3J5CiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9UeXBpbmdETkEvVHlwaW5nRG5hUmVjb3JkZXItSmF2YVNjcmlwdAogKgogKiBAdmVyc2lvbiAzLjEKICogQGF1dGhvciBSYXVsIFBvcGEgJiBTdGVmYW4gRW5kcmVzCiAqIEBjb3B5cmlnaHQgVHlwaW5nRE5BIEluYy4gaHR0cHM6Ly93d3cudHlwaW5nZG5hLmNvbQogKiBAbGljZW5zZSBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIik7CiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4KICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiAqIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAogKgogKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLgogKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKgogKiBUeXBpY2FsIHVzYWdlOgogKiB2YXIgdGRuYSA9IG5ldyBUeXBpbmdETkEoKTsgLy8gY3JlYXRlcyBhIG5ldyBUeXBpbmdETkEgb2JqZWN0IGFuZCBzdGFydHMgcmVjb3JkaW5nCiAqIHZhciB0eXBpbmdQYXR0ZXJuID0gdGRuYS5nZXRUeXBpbmdQYXR0ZXJuKHt0eXBlOjEsIHRleHQ6IkhlbGxvNWcyMT8qIn0pOwogKiByZXR1cm5zIGEgdHlwZSAxIHR5cGluZyBwYXR0ZXJuIChhbmQgY29udGludWVzIHJlY29yZGluZyBhZnRlcndhcmRzKQogKgogKiBPcHRpb25hbDoKICogdGRuYS5zdG9wKCk7IC8vIGVuZHMgcmVjb3JkaW5nIGFuZCBjbGVhcnMgaGlzdG9yeSBzdGFjayAocmV0dXJucyByZWNvcmRpbmcgZmxhZzogZmFsc2UpCiAqIHRkbmEuc3RhcnQoKTsgLy8gcmVzdGFydHMgdGhlIHJlY29yZGluZyBhZnRlciBhIHN0b3AgKHJldHVybnMgcmVjb3JkaW5nIGZsYWc6IHRydWUpCiAqIHRkbmEucmVzZXQoKTsgLy8gcmVzdGFydHMgdGhlIHJlY29yZGluZyBhbnl0aW1lLCBjbGVhcnMgaGlzdG9yeSBzdGFjayBhbmQgc3RhcnRzIGZyb20gc2NyYXRjaCAocmV0dXJucyBub3RoaW5nKQogKiB2YXIgdHlwaW5nUGF0dGVyblF1YWxpdHkgPSBUeXBpbmdETkEuZ2V0UXVhbGl0eSh0eXBpbmdQYXR0ZXJuKTsgLy9yZXR1cm5zIHRoZSBxdWFsaXR5L3N0cmVuZ3RoIG9mIGFueSB0eXBpbmcgcGF0dGVybgogKiAodGhlcmUgaXMgbm8gbmVlZCB0byBpbml0aWFsaXplIHRoZSBjbGFzcyB0byBkbyBwYXR0ZXJuIHF1YWxpdHkgY2hlY2tpbmcpCiAqLwoKLyoqCiAqIENyZWF0ZXMgYSBzaW5nbGUgaW5zdGFuY2UgKG9yIGEgcmVmZXJlbmNlKSBvZiB0aGUgVHlwaW5nRE5BIGNsYXNzCiAqIEByZXR1cm4ge09iamVjdH0gUmV0dXJucyB0aGUgc2luZ2xlIGluc3RhbmNlIG9mIHRoZSBUeXBpbmdETkEgY2xhc3MuCiAqIEBleGFtcGxlIHZhciB0ZG5hID0gbmV3IFR5cGluZ0ROQSgpOwogKi8KZnVuY3Rpb24gVHlwaW5nRE5BKCkgewogIGlmIChUeXBpbmdETkEuaW5pdGlhbGl6ZWQgIT09IHRydWUpIHsKCiAgICAvLyBNQUlOIEZVTkNUSU9OUyAvLwogICAgVHlwaW5nRE5BLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gVHlwaW5nRE5BLnN0YXJ0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgICBUeXBpbmdETkEucHJvdG90eXBlLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFR5cGluZ0ROQS5zdG9wLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgICBUeXBpbmdETkEucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBUeXBpbmdETkEucmVzZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICAgIFR5cGluZ0ROQS5wcm90b3R5cGUuYWRkVGFyZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBUeXBpbmdETkEuYWRkVGFyZ2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgICBUeXBpbmdETkEucHJvdG90eXBlLnJlbW92ZVRhcmdldCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gVHlwaW5nRE5BLnJlbW92ZVRhcmdldC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgVHlwaW5nRE5BLnByb3RvdHlwZS5nZXRUeXBpbmdQYXR0ZXJuID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBUeXBpbmdETkEuZ2V0VHlwaW5nUGF0dGVybi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgVHlwaW5nRE5BLnByb3RvdHlwZS5nZXRNb3VzZURpYWdyYW0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFR5cGluZ0ROQS5nZXRNb3VzZURpYWdyYW0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICAgIFR5cGluZ0ROQS5wcm90b3R5cGUuc3RhcnRNb3VzZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gVHlwaW5nRE5BLnN0YXJ0TW91c2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICAgIFR5cGluZ0ROQS5wcm90b3R5cGUuc3RvcE1vdXNlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBUeXBpbmdETkEuc3RvcE1vdXNlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgICBUeXBpbmdETkEucHJvdG90eXBlLmdldFF1YWxpdHkgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFR5cGluZ0ROQS5nZXRRdWFsaXR5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgICBUeXBpbmdETkEucHJvdG90eXBlLmdldExlbmd0aCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gVHlwaW5nRE5BLmdldExlbmd0aC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgVHlwaW5nRE5BLnByb3RvdHlwZS5pc01vYmlsZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gVHlwaW5nRE5BLmlzTW9iaWxlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgICBUeXBpbmdETkEucHJvdG90eXBlLmdldFRleHRJZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gVHlwaW5nRE5BLmdldFRleHRJZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpCiAgICB9CgogICAgLy8gREVQUkVDQVRFRCBGVU5DVElPTlMgLy8KICAgIFR5cGluZ0ROQS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgZ2V0VHlwaWduUGF0dGVybigpCiAgICAgIHJldHVybiBUeXBpbmdETkEuZ2V0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgICBUeXBpbmdETkEucHJvdG90eXBlLnN0YXJ0RGlhZ3JhbSA9IGZ1bmN0aW9uKCkgewogICAgICAvLyBkZXByZWNhdGVkIGluIGZhdm9yIG9mIHN0YXJ0KCkKICAgICAgLy8gcmV0dXJuIFR5cGluZ0ROQS5zdGFydERpYWdyYW0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICAgIFR5cGluZ0ROQS5wcm90b3R5cGUuc3RvcERpYWdyYW0gPSBmdW5jdGlvbigpIHsKICAgICAgLy8gZGVwcmVjYXRlZCBpbiBmYXZvciBvZiBzdG9wKCkKICAgICAgLy8gcmV0dXJuIFR5cGluZ0ROQS5zdG9wRGlhZ3JhbS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgVHlwaW5nRE5BLnByb3RvdHlwZS5nZXREaWFncmFtID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgZ2V0VHlwaWduUGF0dGVybigpCiAgICAgIHJldHVybiBUeXBpbmdETkEuZ2V0RGlhZ3JhbS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogICAgVHlwaW5nRE5BLnByb3RvdHlwZS5nZXRFeHRlbmRlZERpYWdyYW0gPSBmdW5jdGlvbigpIHsKICAgICAgLy8gZGVwcmVjYXRlZCBpbiBmYXZvciBvZiBnZXRUeXBpZ25QYXR0ZXJuKCkKICAgICAgcmV0dXJuIFR5cGluZ0ROQS5nZXRFeHRlbmRlZERpYWdyYW0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgICBUeXBpbmdETkEuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgVHlwaW5nRE5BLnByb3RvdHlwZS5tYXhIaXN0b3J5TGVuZ3RoID0gVHlwaW5nRE5BLm1heEhpc3RvcnlMZW5ndGg7CiAgICBUeXBpbmdETkEucHJvdG90eXBlLmRlZmF1bHRIaXN0b3J5TGVuZ3RoID0gVHlwaW5nRE5BLmRlZmF1bHRIaXN0b3J5TGVuZ3RoOwogICAgVHlwaW5nRE5BLnByb3RvdHlwZS5tYXhTZWVrVGltZSA9IFR5cGluZ0ROQS5tYXhTZWVrVGltZTsKICAgIFR5cGluZ0ROQS5wcm90b3R5cGUubWF4UHJlc3NUaW1lID0gVHlwaW5nRE5BLm1heFByZXNzVGltZTsKICAgIFR5cGluZ0ROQS52ZXJzaW9uID0gMy4xOwogICAgVHlwaW5nRE5BLmNvb2tpZUlkID0gMDsKICAgIFR5cGluZ0ROQS5mbGFncyA9IDA7CiAgICBUeXBpbmdETkEuaW5zdGFuY2UgPSB0aGlzOwogICAgVHlwaW5nRE5BLmRvY3VtZW50ID0gZG9jdW1lbnQ7CiAgICBUeXBpbmdETkEudWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudCwKICAgICAgVHlwaW5nRE5BLnBsYXRmb3JtID0gd2luZG93Lm5hdmlnYXRvci5wbGF0Zm9ybTsKICAgIFR5cGluZ0ROQS5tYXhIaXN0b3J5TGVuZ3RoID0gMjAwMDsKICAgIFR5cGluZ0ROQS5tYXhTZWVrVGltZSA9IDE1MDA7CiAgICBUeXBpbmdETkEubWF4UHJlc3NUaW1lID0gMzAwOwogICAgVHlwaW5nRE5BLmRlZmF1bHRIaXN0b3J5TGVuZ3RoID0gMTYwOwogICAgVHlwaW5nRE5BLnNwS2V5Q29kZXMgPSBbOCwgMTMsIDMyXTsKICAgIFR5cGluZ0ROQS5zcEtleUNvZGVzT2JqID0gewogICAgICA4OiAxLAogICAgICAxMzogMSwKICAgICAgMzI6IDEsCiAgICB9OwogICAgVHlwaW5nRE5BLmtleUNvZGVzID0gWzY1LCA2NiwgNjcsIDY4LCA2OSwgNzAsIDcxLCA3MiwgNzMsIDc0LCA3NSwgNzYsIDc3LCA3OCwgNzksIDgwLCA4MSwgODIsIDgzLCA4NCwgODUsIDg2LCA4NywgODgsIDg5LCA5MCwKICAgICAgMzIsIDIyMiwgMTg4LCAxOTAsIDE4NiwgMTg3LCAxODksIDE5MSwgNDgsIDQ5LCA1MCwgNTEsIDUyLCA1MywgNTQsIDU1LCA1NiwgNTcKICAgIF07CiAgICBUeXBpbmdETkEua2V5Q29kZXNPYmogPSB7fQogICAgdmFyIGtleUNvZGVzTGVuID0gVHlwaW5nRE5BLmtleUNvZGVzLmxlbmd0aDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5Q29kZXNMZW47IGkrKykgewogICAgICBUeXBpbmdETkEua2V5Q29kZXNPYmpbVHlwaW5nRE5BLmtleUNvZGVzW2ldXSA9IDE7CiAgICB9CiAgICBUeXBpbmdETkEucHQxID0gVHlwaW5nRE5BLnV0MSA9IChuZXcgRGF0ZSkuZ2V0VGltZSgpOwogICAgVHlwaW5nRE5BLndmayA9IFtdOwogICAgVHlwaW5nRE5BLnN0aSA9IFtdOwogICAgVHlwaW5nRE5BLnNrdCA9IFtdOwogICAgVHlwaW5nRE5BLnJlY29yZGluZyA9IHRydWU7CiAgICBUeXBpbmdETkEubW91c2VSZWNvcmRpbmcgPSB0cnVlOwogICAgVHlwaW5nRE5BLm1vdXNlTW92ZVJlY29yZGluZyA9IGZhbHNlOwogICAgVHlwaW5nRE5BLnNwS2V5UmVjb3JkaW5nID0gdHJ1ZTsKICAgIFR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nID0gdHJ1ZTsKICAgIFR5cGluZ0ROQS5tb3Rpb25GaXhlZERhdGEgPSB0cnVlOwogICAgVHlwaW5nRE5BLm1vdGlvbkFycmF5RGF0YSA9IHRydWU7CiAgICBUeXBpbmdETkEuZHdmayA9IFtdOwogICAgVHlwaW5nRE5BLmRzdGkgPSBbXTsKICAgIFR5cGluZ0ROQS5kc2t0ID0gW107CiAgICBUeXBpbmdETkEuZHJrYyA9IFtdOwogICAgVHlwaW5nRE5BLmRsYXN0RG93bktleTsKICAgIFR5cGluZ0ROQS5wcmV2S2V5Q29kZSA9IDA7CiAgICBUeXBpbmdETkEubWF4TW92ZURlbHRhVGltZSA9IDYwMDsKICAgIFR5cGluZ0ROQS5tYXhTY3JvbGxEZWx0YVRpbWUgPSA4MDA7CiAgICBUeXBpbmdETkEubWF4U3RvcFRpbWUgPSAxNTAwOwogICAgVHlwaW5nRE5BLm1heENsaWNrVGltZSA9IDYwMDsKICAgIFR5cGluZ0ROQS5tYXhNb3VzZUhpc3RvcnlMZW5ndGggPSA1MDA7CiAgICBUeXBpbmdETkEubGFzdE1vdXNlTW92ZVRpbWUgPSBUeXBpbmdETkEubGFzdE1vdXNlRG93blRpbWUgPSAobmV3IERhdGUpLmdldFRpbWUoKTsKICAgIFR5cGluZ0ROQS5zdG9wVGltZXMgPSBbXTsKICAgIFR5cGluZ0ROQS5jbGlja1RpbWVzID0gW107CiAgICBUeXBpbmdETkEubGFzdE1vdXNlU3RvcCA9IGZhbHNlOwogICAgVHlwaW5nRE5BLnpsID0gMC4wMDAwMDAxOwogICAgVHlwaW5nRE5BLkFDSW5wdXRMZW5ndGhzID0gewogICAgICBpbnB1dHM6IFtdLAogICAgICBsYXN0TGVuZ3RoOiBbXSwKICAgIH07CiAgICBUeXBpbmdETkEudGFyZ2V0SWRzID0gW107CiAgICBUeXBpbmdETkEubGFzdFRhcmdldCA9ICIiOwogICAgVHlwaW5nRE5BLmxhc3RUYXJnZXRGb3VuZCA9IGZhbHNlOwogICAgVHlwaW5nRE5BLnJlcGxhY2VNaXNzaW5nS2V5cyA9IHRydWU7CiAgICBUeXBpbmdETkEucmVwbGFjZU1pc3NpbmdLZXlzUGVyYyA9IDc7CiAgICBUeXBpbmdETkEucHJlc3NDYWxjdWxhdGVkID0gZmFsc2U7CiAgICBUeXBpbmdETkEucHJlc3NSZWNvcmRlZCA9IGZhbHNlOwoKICAgIFR5cGluZ0ROQS5rZXlEb3duID0gZnVuY3Rpb24oZSkgewogICAgICBpZiAoIVR5cGluZ0ROQS5yZWNvcmRpbmcgJiYgIVR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghVHlwaW5nRE5BLmlzVGFyZ2V0KGUudGFyZ2V0LmlkKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIga2V5Q29kZSA9IGUua2V5Q29kZTsKICAgICAgaWYgKFR5cGluZ0ROQS53Zmtba2V5Q29kZV0gPT09IDEgfHwgVHlwaW5nRE5BLmR3Zmtba2V5Q29kZV0gPT09IDEpIHsKICAgICAgICAvL3JldHVybjsKICAgICAgfQogICAgICB2YXIgdDAgPSBUeXBpbmdETkEucHQxOwogICAgICBUeXBpbmdETkEucHQxID0gKG5ldyBEYXRlKS5nZXRUaW1lKCk7CiAgICAgIHZhciBzZWVrVG90YWwgPSBUeXBpbmdETkEucHQxIC0gdDA7CiAgICAgIHZhciBzdGFydFRpbWUgPSBUeXBpbmdETkEucHQxOwogICAgICBpZiAoVHlwaW5nRE5BLnJlY29yZGluZyA9PT0gdHJ1ZSB8fCAoVHlwaW5nRE5BLnNwS2V5Q29kZXNPYmpba2V5Q29kZV0gJiYgVHlwaW5nRE5BLnNwS2V5UmVjb3JkaW5nID09PSB0cnVlKSkgewogICAgICAgIGlmICghZS5zaGlmdEtleSkgewogICAgICAgICAgVHlwaW5nRE5BLndma1trZXlDb2RlXSA9IDE7CiAgICAgICAgICBUeXBpbmdETkEuc2t0W2tleUNvZGVdID0gc2Vla1RvdGFsOwogICAgICAgICAgVHlwaW5nRE5BLnN0aVtrZXlDb2RlXSA9IHN0YXJ0VGltZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKFR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nID09PSB0cnVlKSB7CiAgICAgICAgVHlwaW5nRE5BLmR3Zmtba2V5Q29kZV0gPSAxOwogICAgICAgIFR5cGluZ0ROQS5kc2t0W2tleUNvZGVdID0gc2Vla1RvdGFsOwogICAgICAgIFR5cGluZ0ROQS5kc3RpW2tleUNvZGVdID0gc3RhcnRUaW1lOwogICAgICAgIFR5cGluZ0ROQS5kbGFzdERvd25LZXkgPSBrZXlDb2RlOwogICAgICB9CiAgICB9CgogICAgVHlwaW5nRE5BLmtleVByZXNzID0gZnVuY3Rpb24oZSkgewogICAgICBpZiAoIVR5cGluZ0ROQS5yZWNvcmRpbmcgJiYgIVR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghVHlwaW5nRE5BLmlzVGFyZ2V0KGUudGFyZ2V0LmlkKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoVHlwaW5nRE5BLmRpYWdyYW1SZWNvcmRpbmcgPT09IHRydWUpIHsKICAgICAgICB2YXIga2V5Q29kZSA9IFR5cGluZ0ROQS5kbGFzdERvd25LZXk7CiAgICAgICAgVHlwaW5nRE5BLmRya2Nba2V5Q29kZV0gPSBlLmNoYXJDb2RlOwogICAgICB9CiAgICB9CgogICAgVHlwaW5nRE5BLmtleVVwID0gZnVuY3Rpb24oZSkgewogICAgICBpZiAoIVR5cGluZ0ROQS5yZWNvcmRpbmcgJiYgIVR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghVHlwaW5nRE5BLmlzVGFyZ2V0KGUudGFyZ2V0LmlkKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgdXQgPSAobmV3IERhdGUpLmdldFRpbWUoKTsKICAgICAgdmFyIGtleUNvZGUgPSBlLmtleUNvZGU7CiAgICAgIHZhciBwcmVzc1RpbWUgPSAwOwogICAgICB2YXIgc2Vla1RpbWUgPSAwOwogICAgICBpZiAoVHlwaW5nRE5BLnJlY29yZGluZyA9PT0gdHJ1ZSB8fCAoVHlwaW5nRE5BLnNwS2V5Q29kZXNPYmpba2V5Q29kZV0gJiYgVHlwaW5nRE5BLnNwS2V5UmVjb3JkaW5nID09PSB0cnVlKSkgewogICAgICAgIGlmICghZS5zaGlmdEtleSkgewogICAgICAgICAgaWYgKFR5cGluZ0ROQS53Zmtba2V5Q29kZV0gPT09IDEpIHsKICAgICAgICAgICAgcHJlc3NUaW1lID0gdXQgLSBUeXBpbmdETkEuc3RpW2tleUNvZGVdOwogICAgICAgICAgICBzZWVrVGltZSA9IFR5cGluZ0ROQS5za3Rba2V5Q29kZV07CiAgICAgICAgICAgIHZhciBhcnIgPSBba2V5Q29kZSwgc2Vla1RpbWUsIHByZXNzVGltZSwgVHlwaW5nRE5BLnByZXZLZXlDb2RlLCB1dCwgZS50YXJnZXQuaWQsXTsKICAgICAgICAgICAgVHlwaW5nRE5BLmhpc3RvcnkuYWRkKGFycik7CiAgICAgICAgICAgIFR5cGluZ0ROQS5wcmV2S2V5Q29kZSA9IGtleUNvZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFR5cGluZ0ROQS53Zmtba2V5Q29kZV0gPSAwOwogICAgICB9CiAgICAgIGlmIChUeXBpbmdETkEuZGlhZ3JhbVJlY29yZGluZyA9PT0gdHJ1ZSkgewogICAgICAgIGlmIChUeXBpbmdETkEuZHJrY1trZXlDb2RlXSAhPT0gdW5kZWZpbmVkICYmIFR5cGluZ0ROQS5kcmtjW2tleUNvZGVdICE9PSAwKSB7CiAgICAgICAgICBpZiAoVHlwaW5nRE5BLmR3Zmtba2V5Q29kZV0gPT09IDEpIHsKICAgICAgICAgICAgcHJlc3NUaW1lID0gdXQgLSBUeXBpbmdETkEuZHN0aVtrZXlDb2RlXTsKICAgICAgICAgICAgc2Vla1RpbWUgPSBUeXBpbmdETkEuZHNrdFtrZXlDb2RlXTsKICAgICAgICAgICAgdmFyIHJlYWxLZXlDb2RlID0gVHlwaW5nRE5BLmRya2Nba2V5Q29kZV07CiAgICAgICAgICAgIHZhciBhcnJEID0gW2tleUNvZGUsIHNlZWtUaW1lLCBwcmVzc1RpbWUsIHJlYWxLZXlDb2RlLCB1dCwgZS50YXJnZXQuaWQsXTsKICAgICAgICAgICAgVHlwaW5nRE5BLmhpc3RvcnkuYWRkRGlhZ3JhbShhcnJEKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgVHlwaW5nRE5BLmR3Zmtba2V5Q29kZV0gPSAwOwogICAgICB9CiAgICB9CgogICAgVHlwaW5nRE5BLk1vYmlsZUtleURvd24gPSBmdW5jdGlvbihlKSB7CiAgICAgIGlmICghVHlwaW5nRE5BLnJlY29yZGluZyAmJiAhVHlwaW5nRE5BLmRpYWdyYW1SZWNvcmRpbmcpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKCFUeXBpbmdETkEuaXNUYXJnZXQoZS50YXJnZXQuaWQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBrZXlDb2RlID0gZS5rZXlDb2RlOwogICAgICBpZiAoVHlwaW5nRE5BLndma1trZXlDb2RlXSA9PT0gMSB8fCBUeXBpbmdETkEuZHdma1trZXlDb2RlXSA9PT0gMSkgewogICAgICAgIC8vcmV0dXJuOwogICAgICB9CiAgICAgIFR5cGluZ0ROQS5sYXN0UHJlc3NUaW1lID0gKG5ldyBEYXRlKS5nZXRUaW1lKCk7CiAgICAgIGlmIChUeXBpbmdETkEucmVjb3JkaW5nID09PSB0cnVlIHx8IChUeXBpbmdETkEuc3BLZXlDb2Rlc09ialtrZXlDb2RlXSAmJiBUeXBpbmdETkEuc3BLZXlSZWNvcmRpbmcgPT09IHRydWUpKSB7CiAgICAgICAgVHlwaW5nRE5BLndma1trZXlDb2RlXSA9IDE7CiAgICAgIH0KICAgICAgaWYgKFR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nID09PSB0cnVlKSB7CiAgICAgICAgVHlwaW5nRE5BLmR3Zmtba2V5Q29kZV0gPSAxOwogICAgICAgIFR5cGluZ0ROQS5kbGFzdERvd25LZXkgPSBrZXlDb2RlOwogICAgICB9CiAgICB9CgogICAgVHlwaW5nRE5BLk1vYmlsZUtleVByZXNzID0gZnVuY3Rpb24oZSkgewogICAgICBpZiAoIVR5cGluZ0ROQS5yZWNvcmRpbmcgJiYgIVR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghVHlwaW5nRE5BLmlzVGFyZ2V0KGUudGFyZ2V0LmlkKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoVHlwaW5nRE5BLmRpYWdyYW1SZWNvcmRpbmcgPT09IHRydWUpIHsKICAgICAgICB2YXIga2V5Q29kZSA9IFR5cGluZ0ROQS5kbGFzdERvd25LZXk7CiAgICAgICAgVHlwaW5nRE5BLmRya2Nba2V5Q29kZV0gPSBlLmNoYXJDb2RlOwogICAgICB9CiAgICB9CgogICAgVHlwaW5nRE5BLk1vYmlsZUtleVVwID0gZnVuY3Rpb24oZSkgewogICAgICBpZiAoIVR5cGluZ0ROQS5yZWNvcmRpbmcgJiYgIVR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghVHlwaW5nRE5BLmlzVGFyZ2V0KGUudGFyZ2V0LmlkKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgdDAgPSBUeXBpbmdETkEudXQxOwogICAgICBUeXBpbmdETkEudXQxID0gKG5ldyBEYXRlKS5nZXRUaW1lKCk7CiAgICAgIHZhciBzZWVrVGltZSA9IFR5cGluZ0ROQS51dDEgLSB0MDsKICAgICAgdmFyIGtwR2V0ID0gVHlwaW5nRE5BLmtwR2V0QWxsKCk7CiAgICAgIHZhciBwcmVzc1RpbWUgPSAoa3BHZXRbMF0gIT09IDApID8gTWF0aC5yb3VuZChUeXBpbmdETkEudXQxIC0ga3BHZXRbMF0pIDogMDsKICAgICAgaWYgKGlzTmFOKHByZXNzVGltZSkpIHsKICAgICAgICBwcmVzc1RpbWUgPSAwOwogICAgICB9CiAgICAgIHZhciBrZXlDb2RlID0gZS5rZXlDb2RlOwogICAgICBpZiAoVHlwaW5nRE5BLnJlY29yZGluZyA9PT0gdHJ1ZSB8fCAoVHlwaW5nRE5BLnNwS2V5Q29kZXNPYmpba2V5Q29kZV0gJiYgVHlwaW5nRE5BLnNwS2V5UmVjb3JkaW5nID09PSB0cnVlKSkgewogICAgICAgIGlmIChUeXBpbmdETkEud2ZrW2tleUNvZGVdID09PSAxKSB7CiAgICAgICAgICB2YXIgYXJyID0gW2tleUNvZGUsIHNlZWtUaW1lLCBwcmVzc1RpbWUsIFR5cGluZ0ROQS5wcmV2S2V5Q29kZSwgVHlwaW5nRE5BLnV0MSwgZS50YXJnZXQuaWRdOwogICAgICAgICAgVHlwaW5nRE5BLmhpc3RvcnkuYWRkKGFycik7CiAgICAgICAgICBUeXBpbmdETkEucHJldktleUNvZGUgPSBrZXlDb2RlOwogICAgICAgIH0KICAgICAgICBUeXBpbmdETkEud2ZrW2tleUNvZGVdID0gMDsKICAgICAgfQogICAgICBpZiAoVHlwaW5nRE5BLmRpYWdyYW1SZWNvcmRpbmcgPT09IHRydWUpIHsKICAgICAgICBpZiAoVHlwaW5nRE5BLmRya2Nba2V5Q29kZV0gIT09IHVuZGVmaW5lZCAmJiBUeXBpbmdETkEuZHJrY1trZXlDb2RlXSAhPT0gMCkgewogICAgICAgICAgaWYgKFR5cGluZ0ROQS5kd2ZrW2tleUNvZGVdID09PSAxKSB7CiAgICAgICAgICAgIHZhciByZWFsS2V5Q29kZSA9IFR5cGluZ0ROQS5kcmtjW2tleUNvZGVdOwogICAgICAgICAgICB2YXIgYXJyRCA9IFtrZXlDb2RlLCBzZWVrVGltZSwgcHJlc3NUaW1lLCByZWFsS2V5Q29kZSwgVHlwaW5nRE5BLnV0MSwgZS50YXJnZXQuaWQsIGtwR2V0WzFdLmpvaW4oJywnKSwga3BHZXRbMl0uam9pbignLCcpLCBrcEdldFszXS5qb2luKCcsJyksIGtwR2V0WzRdLmpvaW4oJywnKV07CiAgICAgICAgICAgIFR5cGluZ0ROQS5oaXN0b3J5LmFkZERpYWdyYW0oYXJyRCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFR5cGluZ0ROQS5kd2ZrW2tleUNvZGVdID0gMDsKICAgICAgfQogICAgfQoKICAgIC8vIG9ubHkgZm9yIEFuZHJvaWQgZGV2aWNlcwogICAgVHlwaW5nRE5BLkFuZHJvaWRLZXlEb3duID0gZnVuY3Rpb24oZSkgewogICAgICBpZiAoIVR5cGluZ0ROQS5yZWNvcmRpbmcgJiYgIVR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICghVHlwaW5nRE5BLmlzVGFyZ2V0KGUudGFyZ2V0LmlkKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBUeXBpbmdETkEubGFzdFByZXNzVGltZSA9IChuZXcgRGF0ZSkuZ2V0VGltZSgpOwogICAgICBpZiAoVHlwaW5nRE5BLkFDSW5wdXRMZW5ndGhzLmlucHV0cy5pbmRleE9mKGUudGFyZ2V0KSA9PT0gLTEpIHsKICAgICAgICBUeXBpbmdETkEuQUNJbnB1dExlbmd0aHMuaW5wdXRzLnB1c2goZS50YXJnZXQpOwogICAgICAgIFR5cGluZ0ROQS5BQ0lucHV0TGVuZ3Rocy5sYXN0TGVuZ3RoLnB1c2goMCk7CiAgICAgIH0KICAgIH0KCiAgICBUeXBpbmdETkEuQW5kcm9pZEtleVVwID0gZnVuY3Rpb24oZSkgewogICAgICBpZiAoIVR5cGluZ0ROQS5yZWNvcmRpbmcgJiYgIVR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciB0MCA9IFR5cGluZ0ROQS51dDE7CiAgICAgIFR5cGluZ0ROQS51dDEgPSAobmV3IERhdGUpLmdldFRpbWUoKTsKICAgICAgaWYgKCFUeXBpbmdETkEuaXNUYXJnZXQoZS50YXJnZXQuaWQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBzZWVrVGltZSA9IFR5cGluZ0ROQS51dDEgLSB0MDsKICAgICAgdmFyIGtwR2V0ID0gVHlwaW5nRE5BLmtwR2V0QWxsKCk7CiAgICAgIHZhciBwcmVzc1RpbWUgPSAoa3BHZXRbMF0gIT09IDApID8gTWF0aC5yb3VuZChUeXBpbmdETkEudXQxIC0ga3BHZXRbMF0pIDogMDsKICAgICAgaWYgKGlzTmFOKHByZXNzVGltZSkpIHsKICAgICAgICBwcmVzc1RpbWUgPSAwOwogICAgICB9CiAgICAgIHZhciBrZXlDb2RlID0gZS5rZXlDb2RlOwogICAgICB2YXIgdGFyZ2V0SW5kZXggPSBUeXBpbmdETkEuQUNJbnB1dExlbmd0aHMuaW5wdXRzLmluZGV4T2YoZS50YXJnZXQpOwogICAgICBpZiAodGFyZ2V0SW5kZXggPT09IC0xKSB7CiAgICAgICAgVHlwaW5nRE5BLkFDSW5wdXRMZW5ndGhzLmlucHV0cy5wdXNoKGUudGFyZ2V0KTsKICAgICAgICBUeXBpbmdETkEuQUNJbnB1dExlbmd0aHMubGFzdExlbmd0aC5wdXNoKDApOwogICAgICAgIHRhcmdldEluZGV4ID0gVHlwaW5nRE5BLkFDSW5wdXRMZW5ndGhzLmlucHV0cy5pbmRleE9mKGUudGFyZ2V0KTsKICAgICAgfQogICAgICB2YXIgY2hhckNvZGUgPSAwOwogICAgICBpZiAoZS50YXJnZXQudmFsdWUubGVuZ3RoID49IFR5cGluZ0ROQS5BQ0lucHV0TGVuZ3Rocy5sYXN0TGVuZ3RoW3RhcmdldEluZGV4XSkgewogICAgICAgIHZhciBjaGFyID0gZS50YXJnZXQudmFsdWUuc3Vic3RyKChlLnRhcmdldC5zZWxlY3Rpb25TdGFydCAtIDEpIHx8IDAsIDEpOwogICAgICAgIGtleUNvZGUgPSBjaGFyLnRvVXBwZXJDYXNlKCkuY2hhckNvZGVBdCgwKTsKICAgICAgICBjaGFyQ29kZSA9IGNoYXIuY2hhckNvZGVBdCgwKTsKICAgICAgfQogICAgICBUeXBpbmdETkEuQUNJbnB1dExlbmd0aHMubGFzdExlbmd0aFt0YXJnZXRJbmRleF0gPSBlLnRhcmdldC52YWx1ZS5sZW5ndGg7CiAgICAgIHZhciBhcnIgPSBba2V5Q29kZSwgc2Vla1RpbWUsIHByZXNzVGltZSwgVHlwaW5nRE5BLnByZXZLZXlDb2RlLCBUeXBpbmdETkEudXQxLCBlLnRhcmdldC5pZCxdOwogICAgICBUeXBpbmdETkEuaGlzdG9yeS5hZGQoYXJyKTsKICAgICAgVHlwaW5nRE5BLnByZXZLZXlDb2RlID0ga2V5Q29kZTsKICAgICAgaWYgKFR5cGluZ0ROQS5kaWFncmFtUmVjb3JkaW5nID09PSB0cnVlKSB7CiAgICAgICAgdmFyIGFyckQgPSBba2V5Q29kZSwgc2Vla1RpbWUsIHByZXNzVGltZSwgY2hhckNvZGUsIFR5cGluZ0ROQS51dDEsIGUudGFyZ2V0LmlkLCBrcEdldFsxXS5qb2luKCcsJyksIGtwR2V0WzJdLmpvaW4oJywnKSwga3BHZXRbM10uam9pbignLCcpLCBrcEdldFs0XS5qb2luKCcsJyldOwogICAgICAgIFR5cGluZ0ROQS5oaXN0b3J5LmFkZERpYWdyYW0oYXJyRCk7CiAgICAgIH0KICAgIH0KCiAgICBUeXBpbmdETkEubW91c2VTY3JvbGwgPSBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChUeXBpbmdETkEubW91c2VSZWNvcmRpbmcgPT09IHRydWUpIHsKICAgICAgICBpZiAoVHlwaW5nRE5BLm1vdXNlTW92ZVJlY29yZGluZyA9PT0gdHJ1ZSkgewogICAgICAgICAgaWYgKFR5cGluZ0ROQS5tb3VzZS5zY3JvbGxTdGFydGVkID09PSB0cnVlKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IChuZXcgRGF0ZSkuZ2V0VGltZSgpOwogICAgICAgICAgICBUeXBpbmdETkEubW91c2Uuc2Nyb2xsVGltZXMucHVzaChjdXJyZW50VGltZSk7CiAgICAgICAgICAgIFR5cGluZ0ROQS5tb3VzZS5zY3JvbGxUb3BBcnIucHVzaChUeXBpbmdETkEuZG9jdW1lbnQuYm9keS5zY3JvbGxUb3ApOwogICAgICAgICAgICBjbGVhckludGVydmFsKFR5cGluZ0ROQS5zY3JvbGxJbnRlcnZhbCk7CiAgICAgICAgICAgIFR5cGluZ0ROQS5zY3JvbGxJbnRlcnZhbCA9IHNldEludGVydmFsKFR5cGluZ0ROQS5tb3VzZS5jaGVja1Njcm9sbCwgVHlwaW5nRE5BLm1heFNjcm9sbERlbHRhVGltZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBUeXBpbmdETkEubW91c2Uuc2Nyb2xsU3RhcnRlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgVHlwaW5nRE5BLm1vdXNlTW92ZSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKFR5cGluZ0ROQS5tb3VzZVJlY29yZGluZyA9PT0gdHJ1ZSkgewogICAgICAgIHZhciBjdXJyZW50VGltZSA9IChuZXcgRGF0ZSkuZ2V0VGltZSgpOwogICAgICAgIGlmIChUeXBpbmdETkEubW91c2VNb3ZlUmVjb3JkaW5nID09PSB0cnVlKSB7CiAgICAgICAgICBpZiAoVHlwaW5nRE5BLm1vdXNlLnN0YXJ0ZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgVHlwaW5nRE5BLm1vdXNlLnRpbWVzLnB1c2goY3VycmVudFRpbWUpOwogICAgICAgICAgICBUeXBpbmdETkEubW91c2UueFBvc2l0aW9ucy5wdXNoKGUuc2NyZWVuWCk7CiAgICAgICAgICAgIFR5cGluZ0ROQS5tb3VzZS55UG9zaXRpb25zLnB1c2goZS5zY3JlZW5ZKTsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChUeXBpbmdETkEubW92ZUludGVydmFsKTsKICAgICAgICAgICAgVHlwaW5nRE5BLm1vdmVJbnRlcnZhbCA9IHNldEludGVydmFsKFR5cGluZ0ROQS5tb3VzZS5jaGVja01vdmUsIFR5cGluZ0ROQS5tYXhNb3ZlRGVsdGFUaW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIFR5cGluZ0ROQS5tb3VzZS5zdGFydGVkID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgVHlwaW5nRE5BLmxhc3RNb3VzZU1vdmVUaW1lID0gY3VycmVudFRpbWU7CiAgICAgIH0KICAgIH0KCiAgICBUeXBpbmdETkEubW91c2VEb3duID0gZnVuY3Rpb24oZSkgewogICAgICBpZiAoVHlwaW5nRE5BLm1vdXNlUmVjb3JkaW5nID09PSB0cnVlKSB7CiAgICAgICAgVHlwaW5nRE5BLm1vdXNlLmNoZWNrTW92ZSgpOwogICAgICAgIFR5cGluZ0ROQS5tb3VzZS5jaGVja1Njcm9sbCgpOwogICAgICAgIGlmIChlLndoaWNoID09PSAxKSB7CiAgICAgICAgICBUeXBpbmdETkEubGFzdE1vdXNlRG93blRpbWUgPSAobmV3IERhdGUpLmdldFRpbWUoKTsKICAgICAgICAgIHZhciBzdG9wVGltZSA9IFR5cGluZ0ROQS5sYXN0TW91c2VEb3duVGltZSAtIFR5cGluZ0ROQS5sYXN0TW91c2VNb3ZlVGltZTsKICAgICAgICAgIGlmIChzdG9wVGltZSA8IFR5cGluZ0ROQS5tYXhTdG9wVGltZSAmJiBUeXBpbmdETkEubGFzdE1vdXNlU3RvcCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgVHlwaW5nRE5BLnN0b3BUaW1lcy5wdXNoKHN0b3BUaW1lKTsKICAgICAgICAgICAgaWYgKFR5cGluZ0ROQS5tb3VzZU1vdmVSZWNvcmRpbmcgPT09IHRydWUpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUeXBlID0gMzsKICAgICAgICAgICAgICB2YXIgYXJyID0gW2V2ZW50VHlwZSwgc3RvcFRpbWUsXTsKICAgICAgICAgICAgICBUeXBpbmdETkEubW91c2UuaGlzdG9yeS5hZGQoYXJyKTsKICAgICAgICAgICAgICBUeXBpbmdETkEubGFzdE1vdXNlU3RvcCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBUeXBpbmdETkEubW91c2VVcCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKFR5cGluZ0ROQS5tb3VzZVJlY29yZGluZyA9PT0gdHJ1ZSkgewogICAgICAgIGlmIChlLndoaWNoID09PSAxKSB7CiAgICAgICAgICB2YXIgY2xpY2tUaW1lID0gKG5ldyBEYXRlKS5nZXRUaW1lKCkgLSBUeXBpbmdETkEubGFzdE1vdXNlRG93blRpbWU7CiAgICAgICAgICBpZiAoY2xpY2tUaW1lIDwgVHlwaW5nRE5BLm1heENsaWNrVGltZSkgewogICAgICAgICAgICBUeXBpbmdETkEuY2xpY2tUaW1lcy5wdXNoKGNsaWNrVGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoVHlwaW5nRE5BLm1vdXNlTW92ZVJlY29yZGluZyA9PT0gdHJ1ZSkgewogICAgICAgICAgICBpZiAoVHlwaW5nRE5BLm1vdXNlLnN0YXJ0ZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICBUeXBpbmdETkEubW91c2UuY2hlY2tNb3ZlKHRydWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBldmVudFR5cGUgPSA0OwogICAgICAgICAgICAgIHZhciBhcnIgPSBbZXZlbnRUeXBlLCBjbGlja1RpbWUsXTsKICAgICAgICAgICAgICBUeXBpbmdETkEubW91c2UuaGlzdG9yeS5hZGQoYXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIFR5cGluZ0ROQS5pc01vYmlsZSA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoVHlwaW5nRE5BLm1vYmlsZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIFR5cGluZ0ROQS5tb2JpbGU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNoZWNrID0gMDsKICAgICAgICAoZnVuY3Rpb24oYSkgewogICAgICAgICAgaWYgKAogICAgICAgICAgICAvKGFuZHJvaWR8YmJcZCt8bWVlZ28pLittb2JpbGV8YXZhbnRnb3xiYWRhXC98YmxhY2tiZXJyeXxibGF6ZXJ8Y29tcGFsfGVsYWluZXxmZW5uZWN8aGlwdG9wfGllbW9iaWxlfGlwKGhvbmV8b2QpfGlyaXN8a2luZGxlfGxnZSB8bWFlbW98bWlkcHxtbXB8bW9iaWxlLitmaXJlZm94fG5ldGZyb250fG9wZXJhIG0ob2J8aW4paXxwYWxtKCBvcyk/fHBob25lfHAoaXhpfHJlKVwvfHBsdWNrZXJ8cG9ja2V0fHBzcHxzZXJpZXMoNHw2KTB8c3ltYmlhbnx0cmVvfHVwXC4oYnJvd3NlcnxsaW5rKXx2b2RhZm9uZXx3YXB8d2luZG93cyBjZXx4ZGF8eGlpbm98YW5kcm9pZHxpcGFkfHBsYXlib29rfHNpbGsvaQogICAgICAgICAgICAudGVzdChhKSB8fAogICAgICAgICAgICAvMTIwN3w2MzEwfDY1OTB8M2dzb3w0dGhwfDUwWzEtNl1pfDc3MHN8ODAyc3xhIHdhfGFiYWN8YWMoZXJ8b298c1wtKXxhaShrb3xybil8YWwoYXZ8Y2F8Y28pfGFtb2l8YW4oZXh8bnl8eXcpfGFwdHV8YXIoY2h8Z28pfGFzKHRlfHVzKXxhdHR3fGF1KGRpfFwtbXxyIHxzICl8YXZhbnxiZShja3xsbHxucSl8YmkobGJ8cmQpfGJsKGFjfGF6KXxicihlfHYpd3xidW1ifGJ3XC0obnx1KXxjNTVcL3xjYXBpfGNjd2F8Y2RtXC18Y2VsbHxjaHRtfGNsZGN8Y21kXC18Y28obXB8bmQpfGNyYXd8ZGEoaXR8bGx8bmcpfGRidGV8ZGNcLXN8ZGV2aXxkaWNhfGRtb2J8ZG8oY3xwKW98ZHMoMTJ8XC1kKXxlbCg0OXxhaSl8ZW0obDJ8dWwpfGVyKGljfGswKXxlc2w4fGV6KFs0LTddMHxvc3x3YXx6ZSl8ZmV0Y3xmbHkoXC18Xyl8ZzEgdXxnNTYwfGdlbmV8Z2ZcLTV8Z1wtbW98Z28oXC53fG9kKXxncihhZHx1bil8aGFpZXxoY2l0fGhkXC0obXxwfHQpfGhlaVwtfGhpKHB0fHRhKXxocCggaXxpcCl8aHNcLWN8aHQoYyhcLXwgfF98YXxnfHB8c3x0KXx0cCl8aHUoYXd8dGMpfGlcLSgyMHxnb3xtYSl8aTIzMHxpYWMoIHxcLXxcLyl8aWJyb3xpZGVhfGlnMDF8aWtvbXxpbTFrfGlubm98aXBhcXxpcmlzfGphKHR8dilhfGpicm98amVtdXxqaWdzfGtkZGl8a2VqaXxrZ3QoIHxcLyl8a2xvbnxrcHQgfGt3Y1wtfGt5byhjfGspfGxlKG5vfHhpKXxsZyggZ3xcLyhrfGx8dSl8NTB8NTR8XC1bYS13XSl8bGlid3xseW54fG0xXC13fG0zZ2F8bTUwXC98bWEodGV8dWl8eG8pfG1jKDAxfDIxfGNhKXxtXC1jcnxtZShyY3xyaSl8bWkobzh8b2F8dHMpfG1tZWZ8bW8oMDF8MDJ8Yml8ZGV8ZG98dChcLXwgfG98dil8enopfG10KDUwfHAxfHYgKXxtd2JwfG15d2F8bjEwWzAtMl18bjIwWzItM118bjMwKDB8Mil8bjUwKDB8Mnw1KXxuNygwKDB8MSl8MTApfG5lKChjfG0pXC18b258dGZ8d2Z8d2d8d3QpfG5vayg2fGkpfG56cGh8bzJpbXxvcCh0aXx3dil8b3Jhbnxvd2cxfHA4MDB8cGFuKGF8ZHx0KXxwZHhnfHBnKDEzfFwtKFsxLThdfGMpKXxwaGlsfHBpcmV8cGwoYXl8dWMpfHBuXC0yfHBvKGNrfHJ0fHNlKXxwcm94fHBzaW98cHRcLWd8cWFcLWF8cWMoMDd8MTJ8MjF8MzJ8NjB8XC1bMi03XXxpXC0pfHF0ZWt8cjM4MHxyNjAwfHJha3N8cmltOXxybyh2ZXx6byl8czU1XC98c2EoZ2V8bWF8bW18bXN8bnl8dmEpfHNjKDAxfGhcLXxvb3xwXC0pfHNka1wvfHNlKGMoXC18MHwxKXw0N3xtY3xuZHxyaSl8c2doXC18c2hhcnxzaWUoXC18bSl8c2tcLTB8c2woNDV8aWQpfHNtKGFsfGFyfGIzfGl0fHQ1KXxzbyhmdHxueSl8c3AoMDF8aFwtfHZcLXx2ICl8c3koMDF8bWIpfHQyKDE4fDUwKXx0NigwMHwxMHwxOCl8dGEoZ3R8bGspfHRjbFwtfHRkZ1wtfHRlbChpfG0pfHRpbVwtfHRcLW1vfHRvKHBsfHNoKXx0cyg3MHxtXC18bTN8bTUpfHR4XC05fHVwKFwuYnxnMXxzaSl8dXRzdHx2NDAwfHY3NTB8dmVyaXx2aShyZ3x0ZSl8dmsoNDB8NVswLTNdfFwtdil8dm00MHx2b2RhfHZ1bGN8dngoNTJ8NTN8NjB8NjF8NzB8ODB8ODF8ODN8ODV8OTgpfHczYyhcLXwgKXx3ZWJjfHdoaXR8d2koZyB8bmN8bncpfHdtbGJ8d29udXx4NzAwfHlhc1wtfHlvdXJ8emV0b3x6dGVcLS9pCiAgICAgICAgICAgIC50ZXN0KGEuc3Vic3RyKDAsIDQpKSkgewogICAgICAgICAgICBjaGVjayA9IDE7CiAgICAgICAgICB9CiAgICAgICAgfSkobmF2aWdhdG9yLnVzZXJBZ2VudCB8fCBuYXZpZ2F0b3IudmVuZG9yIHx8IHdpbmRvdy5vcGVyYSk7CiAgICAgICAgVHlwaW5nRE5BLm1vYmlsZSA9IGNoZWNrOwogICAgICAgIHJldHVybiBjaGVjazsKICAgICAgfQogICAgfQoKICAgIFR5cGluZ0ROQS5pc0FuZHJvaWQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIC9BbmRyb2lkL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KTsKICAgIH0KCiAgICBUeXBpbmdETkEuaXNGaXJlZm94ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAvRmlyZWZveC9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCk7CiAgICB9CgogICAgVHlwaW5nRE5BLmlzVGFyZ2V0ID0gZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgIGlmIChUeXBpbmdETkEubGFzdFRhcmdldCA9PT0gdGFyZ2V0ICYmIFR5cGluZ0ROQS5sYXN0VGFyZ2V0Rm91bmQpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdGFyZ2V0TGVuZ3RoID0gVHlwaW5nRE5BLnRhcmdldElkcy5sZW5ndGg7CiAgICAgICAgdmFyIHRhcmdldEZvdW5kID0gZmFsc2U7CiAgICAgICAgaWYgKHRhcmdldExlbmd0aCA+IDApIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGFyZ2V0TGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKFR5cGluZ0ROQS50YXJnZXRJZHNbaV0gPT09IHRhcmdldCkgewogICAgICAgICAgICAgIHRhcmdldEZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgVHlwaW5nRE5BLmxhc3RUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICBUeXBpbmdETkEubGFzdFRhcmdldEZvdW5kID0gdGFyZ2V0Rm91bmQ7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0Rm91bmQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIFR5cGluZ0ROQS5sYXN0VGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgICAgVHlwaW5nRE5BLmxhc3RUYXJnZXRGb3VuZCA9IHRydWU7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBUeXBpbmdETkEua3BBY2NaID0gW107CiAgICBUeXBpbmdETkEua3BYID0gW107CiAgICBUeXBpbmdETkEua3BZID0gW107CiAgICBUeXBpbmdETkEua3BUaW1lcyA9IFtdOwogICAgVHlwaW5nRE5BLmtwTGFzdFogPSAwOwogICAgVHlwaW5nRE5BLmtwTGFzdEFjY1ggPSAwOwogICAgVHlwaW5nRE5BLmtwTGFzdEFjY1kgPSAwOwogICAgVHlwaW5nRE5BLmtwTGFzdFBpdGNoID0gMDsKICAgIFR5cGluZ0ROQS5rcExhc3RSb2xsID0gMDsKICAgIFR5cGluZ0ROQS5sYXN0UHJlc3NUaW1lID0gMDsKICAgIFR5cGluZ0ROQS5oYXNEZXZpY2VNb3Rpb24gPSBmYWxzZTsKICAgIFR5cGluZ0ROQS5oYXNEZXZpY2VPcmllbnRhdGlvbiA9IGZhbHNlOwoKICAgIFR5cGluZ0ROQS5kZXZpY2VNb3Rpb25IYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICBUeXBpbmdETkEua3BUaW1lcy5wdXNoKChuZXcgRGF0ZSkuZ2V0VGltZSgpKTsKICAgICAgdmFyIGtwQ3VyQWNjWCA9IE1hdGgucm91bmQoMTAwICogZS5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5LngpOwogICAgICB2YXIga3BDdXJBY2NZID0gTWF0aC5yb3VuZCgxMDAgKiBlLmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHkueSk7CiAgICAgIHZhciBrcEN1ckFjY1ogPSBNYXRoLnJvdW5kKDEwMCAqIGUuYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eS56KTsKICAgICAgaWYgKGUucm90YXRpb25SYXRlKSB7CiAgICAgICAgdmFyIGtwQ3VyWCA9IE1hdGgucm91bmQoMTAgKiBlLnJvdGF0aW9uUmF0ZS5hbHBoYSk7CiAgICAgICAgdmFyIGtwQ3VyWSA9IE1hdGgucm91bmQoMTAgKiBlLnJvdGF0aW9uUmF0ZS5iZXRhKTsKICAgICAgICB2YXIga3BDdXJaID0gTWF0aC5yb3VuZCgxMCAqIGUucm90YXRpb25SYXRlLmdhbW1hKTsKICAgICAgfQogICAgICBUeXBpbmdETkEua3BMYXN0QWNjWCA9IGtwQ3VyQWNjWDsKICAgICAgVHlwaW5nRE5BLmtwTGFzdEFjY1kgPSBrcEN1ckFjY1k7CiAgICAgIFR5cGluZ0ROQS5rcEFjY1oucHVzaChrcEN1ckFjY1opOwogICAgICBUeXBpbmdETkEua3BYLnB1c2goa3BDdXJYKTsKICAgICAgVHlwaW5nRE5BLmtwWS5wdXNoKGtwQ3VyWSk7CiAgICAgIFR5cGluZ0ROQS5rcExhc3RaID0ga3BDdXJaOwoKICAgICAgVHlwaW5nRE5BLmtwTGFzdFBpdGNoID0gTWF0aC5mbG9vcigoTWF0aC5hdGFuMigta3BDdXJBY2NZLCBNYXRoLnNxcnQoTWF0aC5wb3coa3BDdXJBY2NYLCAyKSArIE1hdGgucG93KGtwQ3VyQWNjWiwgMikpKSAqIDE4MCAvIE1hdGguUEkpICogMTApOwogICAgICBUeXBpbmdETkEua3BMYXN0Um9sbCA9IE1hdGguZmxvb3IoKE1hdGguYXRhbjIoLWtwQ3VyQWNjWCwgTWF0aC5zcXJ0KE1hdGgucG93KGtwQ3VyQWNjWSwgMikgKyBNYXRoLnBvdyhrcEN1ckFjY1osIDIpKSkgKiAxODAgLyBNYXRoLlBJKSAqIDEwKTsKICAgICAgaWYgKFR5cGluZ0ROQS5rcFgubGVuZ3RoID4gMjEpIHsKICAgICAgICBUeXBpbmdETkEua3BUaW1lcy5zaGlmdCgpOwogICAgICAgIFR5cGluZ0ROQS5rcEFjY1ouc2hpZnQoKTsKICAgICAgICBUeXBpbmdETkEua3BYLnNoaWZ0KCk7CiAgICAgICAgVHlwaW5nRE5BLmtwWS5zaGlmdCgpOwogICAgICB9CiAgICAgIGlmICghVHlwaW5nRE5BLmhhc0RldmljZU1vdGlvbikgewogICAgICAgIFR5cGluZ0ROQS5oYXNEZXZpY2VNb3Rpb24gPSB0cnVlOwogICAgICAgIFR5cGluZ0ROQS5oYXNEZXZpY2VPcmllbnRhdGlvbiA9IHRydWU7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoVHlwaW5nRE5BLmlzTW9iaWxlKCkgPT09IDEpIHsKICAgICAgaWYgKFR5cGluZ0ROQS5pc0FuZHJvaWQoKSkgewogICAgICAgIGlmIChUeXBpbmdETkEuaXNGaXJlZm94KCkpIHsKICAgICAgICAgIFR5cGluZ0ROQS5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJpbnB1dCIsIFR5cGluZ0ROQS5BbmRyb2lkS2V5VXApOwogICAgICAgICAgVHlwaW5nRE5BLmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCBUeXBpbmdETkEuQW5kcm9pZEtleURvd24pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBUeXBpbmdETkEuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigia2V5dXAiLCBUeXBpbmdETkEuQW5kcm9pZEtleVVwKTsKICAgICAgICAgIFR5cGluZ0ROQS5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgVHlwaW5nRE5BLkFuZHJvaWRLZXlEb3duKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgVHlwaW5nRE5BLmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleXVwIiwgVHlwaW5nRE5BLk1vYmlsZUtleVVwKTsKICAgICAgICBUeXBpbmdETkEuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIFR5cGluZ0ROQS5Nb2JpbGVLZXlEb3duKTsKICAgICAgICBUeXBpbmdETkEuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigia2V5cHJlc3MiLCBUeXBpbmdETkEuTW9iaWxlS2V5UHJlc3MpOwogICAgICB9CiAgICAgIGlmICh3aW5kb3cuRGV2aWNlTW90aW9uRXZlbnQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdkZXZpY2Vtb3Rpb24nLCBUeXBpbmdETkEuZGV2aWNlTW90aW9uSGFuZGxlcik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChUeXBpbmdETkEuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgIFR5cGluZ0ROQS5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXl1cCIsIFR5cGluZ0ROQS5rZXlVcCk7CiAgICAgICAgVHlwaW5nRE5BLmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCBUeXBpbmdETkEua2V5RG93bik7CiAgICAgICAgVHlwaW5nRE5BLmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleXByZXNzIiwgVHlwaW5nRE5BLmtleVByZXNzKTsKICAgICAgICBUeXBpbmdETkEuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vtb3ZlIiwgVHlwaW5nRE5BLm1vdXNlTW92ZSk7CiAgICAgICAgVHlwaW5nRE5BLmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIFR5cGluZ0ROQS5tb3VzZURvd24pOwogICAgICAgIFR5cGluZ0ROQS5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgVHlwaW5nRE5BLm1vdXNlVXApOwogICAgICAgIFR5cGluZ0ROQS5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJzY3JvbGwiLCBUeXBpbmdETkEubW91c2VTY3JvbGwpOwogICAgICB9IGVsc2UgaWYgKFR5cGluZ0ROQS5kb2N1bWVudC5hdHRhY2hFdmVudCkgewogICAgICAgIFR5cGluZ0ROQS5kb2N1bWVudC5hdHRhY2hFdmVudCgib25rZXl1cCIsIFR5cGluZ0ROQS5rZXlVcCk7CiAgICAgICAgVHlwaW5nRE5BLmRvY3VtZW50LmF0dGFjaEV2ZW50KCJvbmtleWRvd24iLCBUeXBpbmdETkEua2V5RG93bik7CiAgICAgICAgVHlwaW5nRE5BLmRvY3VtZW50LmF0dGFjaEV2ZW50KCJvbmtleXByZXNzIiwgVHlwaW5nRE5BLmtleVByZXNzKTsKICAgICAgICBUeXBpbmdETkEuZG9jdW1lbnQuYXR0YWNoRXZlbnQoIm9ubW91c2Vtb3ZlIiwgVHlwaW5nRE5BLm1vdXNlTW92ZSk7CiAgICAgICAgVHlwaW5nRE5BLmRvY3VtZW50LmF0dGFjaEV2ZW50KCJvbm1vdXNlZG93biIsIFR5cGluZ0ROQS5tb3VzZURvd24pOwogICAgICAgIFR5cGluZ0ROQS5kb2N1bWVudC5hdHRhY2hFdmVudCgib25tb3VzZXVwIiwgVHlwaW5nRE5BLm1vdXNlVXApOwogICAgICAgIFR5cGluZ0ROQS5kb2N1bWVudC5hdHRhY2hFdmVudCgib25zY3JvbGwiLCBUeXBpbmdETkEubW91c2VTY3JvbGwpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKCJicm93c2VyIG5vdCBzdXBwb3J0ZWQiKTsKICAgICAgfQogICAgfQoKICAgIFR5cGluZ0ROQS5rcEFEaWZBcnIgPSBmdW5jdGlvbihhcnIpIHsKICAgICAgdmFyIGxlbmd0aCA9IGFyci5sZW5ndGggLSAxOwogICAgICB2YXIgZmlyc3RBcnIgPSBbMF07CiAgICAgIGlmIChsZW5ndGggPCAyKSB7CiAgICAgICAgcmV0dXJuIFsKICAgICAgICAgIFswXSwKICAgICAgICAgIFswXQogICAgICAgIF07CiAgICAgIH0KICAgICAgdmFyIG5ld0FyciA9IFtdOwogICAgICB2YXIgcmV0dXJuQXJyID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBmaXJzdEFyci5wdXNoKGFycltpICsgMV0gLSBhcnJbaV0pOwogICAgICB9CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHZhciBuZXdWYWwgPSBmaXJzdEFycltpICsgMV0gLSBmaXJzdEFycltpXTsKICAgICAgICBuZXdBcnIucHVzaChuZXdWYWwpOwogICAgICAgIHJldHVybkFyci5wdXNoKE1hdGguYWJzKG5ld1ZhbCkpOwogICAgICB9CiAgICAgIHJldHVybiBbbmV3QXJyLCByZXR1cm5BcnIsXTsKICAgIH0KCiAgICBUeXBpbmdETkEua3BSRGlmQXJyID0gZnVuY3Rpb24oYXJyKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnIubGVuZ3RoIC0gMjsKICAgICAgdmFyIGZpcnN0QXJyID0gW107CiAgICAgIGlmIChsZW5ndGggPCAwKSB7CiAgICAgICAgcmV0dXJuIFsKICAgICAgICAgIFswXSwKICAgICAgICAgIFswXQogICAgICAgIF07CiAgICAgIH0KICAgICAgdmFyIGxvY2FsTWF4ID0gMDsKICAgICAgdmFyIGxvY2FsTWluID0gMDsKICAgICAgdmFyIHBvc01heCA9IDA7CiAgICAgIHZhciBwb3NNaW4gPSAwOwogICAgICB2YXIgbmV3VmFsID0gMDsKICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG5ld1ZhbCA9IGFycltpICsgMV0gLSBhcnJbaV07CiAgICAgICAgICBmaXJzdEFyci5wdXNoKG5ld1ZhbCk7CiAgICAgICAgICBpZiAobmV3VmFsID49IGxvY2FsTWF4KSB7CiAgICAgICAgICAgIGxvY2FsTWF4ID0gbmV3VmFsOwogICAgICAgICAgICBwb3NNYXggPSBpOwogICAgICAgICAgfSBlbHNlIGlmIChuZXdWYWwgPD0gbG9jYWxNaW4pIHsKICAgICAgICAgICAgbG9jYWxNaW4gPSBuZXdWYWw7CiAgICAgICAgICAgIHBvc01pbiA9IGk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG5ld1ZhbCA9IGFyclsxXSAtIGFyclswXTsKICAgICAgICBmaXJzdEFyci5wdXNoKG5ld1ZhbCk7CiAgICAgIH0KICAgICAgdmFyIHJldHVybkFyciA9IFtwb3NNYXggLSAxLCBwb3NNYXgsIHBvc01heCArIDEsIHBvc01heCArIDIsIHBvc01heCArIDMsIHBvc01pbiAtIDEsIHBvc01pbiwgcG9zTWluICsgMSwgcG9zTWluICsgMiwgcG9zTWluICsgM107CiAgICAgIHJldHVybiBbZmlyc3RBcnIsIHJldHVybkFycixdOwogICAgfQoKICAgIFR5cGluZ0ROQS5rcEdldEFsbCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgcmV0dXJuVmFsID0gMDsKICAgICAgdmFyIHJldHVybk1vdGlvbiA9IFtdOwogICAgICBpZiAoVHlwaW5nRE5BLmtwQWNjWi5sZW5ndGggPCAyKSB7CiAgICAgICAgcmV0dXJuVmFsID0gKFR5cGluZ0ROQS5oYXNEZXZpY2VNb3Rpb24gJiYgVHlwaW5nRE5BLmhhc0RldmljZU9yaWVudGF0aW9uKSA/IDAgOiBUeXBpbmdETkEubGFzdFByZXNzVGltZTsKICAgICAgICByZXR1cm5Nb3Rpb24gPSBbMCwgMCwgMCwgMCwgMCwgMCwgVHlwaW5nRE5BLmtwTGFzdFBpdGNoLCBUeXBpbmdETkEua3BMYXN0Um9sbCxdOwogICAgICAgIHJldHVybiBbcmV0dXJuVmFsLCByZXR1cm5Nb3Rpb24sIFswXSwKICAgICAgICAgIFswXSwKICAgICAgICAgIFswXQogICAgICAgIF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgW2twemEsIGtwemFBYnNdID0gVHlwaW5nRE5BLmtwQURpZkFycihUeXBpbmdETkEua3BBY2NaKTsKICAgICAgICBba3BYUiwga3B4UG9zXSA9IFR5cGluZ0ROQS5rcFJEaWZBcnIoVHlwaW5nRE5BLmtwWCk7CiAgICAgICAgW2twWVIsIGtweVBvc10gPSBUeXBpbmdETkEua3BSRGlmQXJyKFR5cGluZ0ROQS5rcFkpOwogICAgICAgIFR5cGluZ0ROQS5rcFguc2hpZnQoKTsKICAgICAgICBUeXBpbmdETkEua3BZLnNoaWZ0KCk7CiAgICAgICAgVHlwaW5nRE5BLmtwQWNjWi5zaGlmdCgpOwogICAgICAgIFR5cGluZ0ROQS5rcFRpbWVzLnNoaWZ0KCk7CiAgICAgICAgdmFyIGtwUG9zID0ga3B4UG9zLmNvbmNhdChrcHlQb3MpOwogICAgICAgIGtwUG9zID0ga3BQb3Muc29ydCgpOwogICAgICAgIHZhciBrcHh5UG9zID0gW107CiAgICAgICAgZm9yIChpID0gMTsgaSA8IGtwUG9zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoa3BQb3NbaV0gIT09IGtwUG9zW2kgLSAxXSkgewogICAgICAgICAgICBrcHh5UG9zLnB1c2goa3BQb3NbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgbGFzdEtwemEgPSAwOwogICAgICAgIHZhciBsYXN0S3BUaW1lID0gVHlwaW5nRE5BLmtwVGltZXNbVHlwaW5nRE5BLmtwVGltZXMubGVuZ3RoIC0gMV07CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGtweHlQb3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBqID0ga3B4eVBvc1tpXTsKICAgICAgICAgIHZhciBtaW5qID0gKGtwemFBYnMubGVuZ3RoID4gOCkgPyAyIDogKChrcHphQWJzLmxlbmd0aCA+IDQpID8gMSA6IDApOwogICAgICAgICAgaWYgKGogPiBtaW5qICYmIGtwemFBYnNbal0gIT09IHVuZGVmaW5lZCAmJiBrcHphQWJzW2pdID4gbGFzdEtwemEpIHsKICAgICAgICAgICAgbGFzdEtwemEgPSBrcHphQWJzW2pdOwogICAgICAgICAgICBsYXN0S3BUaW1lID0gVHlwaW5nRE5BLmtwVGltZXNbal07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVyblZhbCA9IGxhc3RLcFRpbWU7CiAgICAgICAgcmV0dXJuTW90aW9uID0gW1R5cGluZ0ROQS5rcExhc3RBY2NYLCBUeXBpbmdETkEua3BMYXN0QWNjWSwgVHlwaW5nRE5BLmtwQWNjWi5wb3AoKSwgVHlwaW5nRE5BLmtwWC5wb3AoKSwgVHlwaW5nRE5BLmtwWS5wb3AoKSwgVHlwaW5nRE5BLmtwTGFzdFosIFR5cGluZ0ROQS5rcExhc3RQaXRjaCwgVHlwaW5nRE5BLmtwTGFzdFJvbGxdOwogICAgICAgIFR5cGluZ0ROQS5rcFggPSBbXTsKICAgICAgICBUeXBpbmdETkEua3BZID0gW107CiAgICAgICAgVHlwaW5nRE5BLmtwQWNjWiA9IFtdOwogICAgICAgIFR5cGluZ0ROQS5rcFRpbWVzID0gW107CiAgICAgICAgaWYgKCFUeXBpbmdETkEucHJlc3NDYWxjdWxhdGVkKSB7CiAgICAgICAgICBUeXBpbmdETkEucHJlc3NDYWxjdWxhdGVkID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBbcmV0dXJuVmFsLCByZXR1cm5Nb3Rpb24sIGtwemEsIGtwWFIsIGtwWVIsXTsKICAgICAgfQogICAgfQoKICAgIFR5cGluZ0ROQS5tb3VzZSA9IHt9OwogICAgVHlwaW5nRE5BLm1vdXNlLnRpbWVzID0gW107CiAgICBUeXBpbmdETkEubW91c2UueFBvc2l0aW9ucyA9IFtdOwogICAgVHlwaW5nRE5BLm1vdXNlLnlQb3NpdGlvbnMgPSBbXTsKICAgIFR5cGluZ0ROQS5tb3VzZS5zY3JvbGxUaW1lcyA9IFtdOwogICAgVHlwaW5nRE5BLm1vdXNlLnNjcm9sbFRvcEFyciA9IFtdOwogICAgVHlwaW5nRE5BLm1vdXNlLmhpc3RvcnkgPSB7fTsKICAgIFR5cGluZ0ROQS5tb3VzZS5oaXN0b3J5LnN0YWNrID0gW107CgogICAgVHlwaW5nRE5BLm1vdXNlLmdldERpc3RhbmNlID0gZnVuY3Rpb24oYSwgYikgewogICAgICByZXR1cm4gTWF0aC5zcXJ0KChhICogYSkgKyAoYiAqIGIpKTsKICAgIH0KCiAgICBUeXBpbmdETkEubW91c2UuZ2V0VG90YWxEaXN0YW5jZSA9IGZ1bmN0aW9uKHhQb3NpdGlvbnMsIHlQb3NpdGlvbnMpIHsKICAgICAgdmFyIHRvdGFsRGlzdGFuY2UgPSAwOwogICAgICB2YXIgbGVuZ3RoID0geFBvc2l0aW9ucy5sZW5ndGg7CiAgICAgIGZvciAoaSA9IDE7IGkgPCBsZW5ndGggLSAxOyBpKyspIHsKICAgICAgICB2YXIgYSA9IHhQb3NpdGlvbnNbaV0gLSB4UG9zaXRpb25zW2kgLSAxXTsKICAgICAgICB2YXIgYiA9IHlQb3NpdGlvbnNbaV0gLSB5UG9zaXRpb25zW2kgLSAxXTsKICAgICAgICB0b3RhbERpc3RhbmNlICs9IFR5cGluZ0ROQS5tb3VzZS5nZXREaXN0YW5jZShhLCBiKTsKICAgICAgfQogICAgICByZXR1cm4gdG90YWxEaXN0YW5jZTsKICAgIH0KCiAgICBUeXBpbmdETkEubW91c2UuZ2V0QW5nbGUgPSBmdW5jdGlvbih4UG9zRGVsdGEsIHlQb3NEZWx0YSkgewogICAgICB2YXIgYW5nbGUgPSAwOwogICAgICB2YXIgbGVmdFJpZ2h0ID0gKHhQb3NEZWx0YSA+PSAwKTsgLy8gMSBpZiBsZWZ0LCAwIGlmIHJpZ2h0CiAgICAgIHZhciBkb3duVXAgPSAoeVBvc0RlbHRhIDwgMCk7IC8vIDEgaWYgZG93biwgMCBpZiB1cAogICAgICBpZiAobGVmdFJpZ2h0KSB7CiAgICAgICAgaWYgKGRvd25VcCkgewogICAgICAgICAgYW5nbGUgPSAxODAgKyAoTWF0aC5yb3VuZChNYXRoLmF0YW4oTWF0aC5hYnMoeFBvc0RlbHRhKSAvIChNYXRoLmFicyh5UG9zRGVsdGEpICsgMC4wMDAwMDAxKSkgLyAwLjAxNzQ1MzI5MjUxKSkgLy8gMC4wMTc0NTMyOTI1MSA9IHBpLzE4MAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhbmdsZSA9IDI3MCArICg5MCAtIE1hdGgucm91bmQoTWF0aC5hdGFuKE1hdGguYWJzKHhQb3NEZWx0YSkgLyAoTWF0aC5hYnMoeVBvc0RlbHRhKSArIDAuMDAwMDAwMSkpIC8gMC4wMTc0NTMyOTI1MSkpCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChkb3duVXApIHsKICAgICAgICAgIGFuZ2xlID0gOTAgKyAoOTAgLSBNYXRoLnJvdW5kKE1hdGguYXRhbihNYXRoLmFicyh4UG9zRGVsdGEpIC8gKE1hdGguYWJzKHlQb3NEZWx0YSkgKyAwLjAwMDAwMDEpKSAvIDAuMDE3NDUzMjkyNTEpKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhbmdsZSA9IE1hdGgucm91bmQoTWF0aC5hdGFuKE1hdGguYWJzKHhQb3NEZWx0YSkgLyAoTWF0aC5hYnMoeVBvc0RlbHRhKSArIDAuMDAwMDAwMSkpIC8gMC4wMTc0NTMyOTI1MSkKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGFuZ2xlOwogICAgfQoKICAgIFR5cGluZ0ROQS5tb3VzZS5yZWNvcmRNb3ZlQWN0aW9uID0gZnVuY3Rpb24oZHJhZykgewogICAgICB2YXIgbGVuZ3RoID0gVHlwaW5nRE5BLm1vdXNlLnRpbWVzLmxlbmd0aDsKICAgICAgaWYgKGxlbmd0aCA8IDMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGRlbHRhVGltZSA9IFR5cGluZ0ROQS5tb3VzZS50aW1lc1tsZW5ndGggLSAxXSAtIFR5cGluZ0ROQS5tb3VzZS50aW1lc1swXTsKICAgICAgdmFyIHhQb3NEZWx0YSA9IFR5cGluZ0ROQS5tb3VzZS54UG9zaXRpb25zW2xlbmd0aCAtIDFdIC0gVHlwaW5nRE5BLm1vdXNlLnhQb3NpdGlvbnNbMF07CiAgICAgIHZhciB5UG9zRGVsdGEgPSBUeXBpbmdETkEubW91c2UueVBvc2l0aW9uc1tsZW5ndGggLSAxXSAtIFR5cGluZ0ROQS5tb3VzZS55UG9zaXRpb25zWzBdOwogICAgICB2YXIgZGlyZWN0RGlzdGFuY2UgPSBNYXRoLnJvdW5kKFR5cGluZ0ROQS5tb3VzZS5nZXREaXN0YW5jZSh4UG9zRGVsdGEsIHlQb3NEZWx0YSkpOwogICAgICB2YXIgdG90YWxEaXN0YW5jZSA9IE1hdGgucm91bmQoVHlwaW5nRE5BLm1vdXNlLmdldFRvdGFsRGlzdGFuY2UoVHlwaW5nRE5BLm1vdXNlLnhQb3NpdGlvbnMsIFR5cGluZ0ROQS5tb3VzZS55UG9zaXRpb25zKSk7CiAgICAgIHZhciByYXRpb0Rpc3RhbmNlID0gTWF0aC5yb3VuZCh0b3RhbERpc3RhbmNlICogMTAwIC8gZGlyZWN0RGlzdGFuY2UpOwogICAgICB2YXIgc3BlZWQgPSBNYXRoLnJvdW5kKGRpcmVjdERpc3RhbmNlICogMTAwIC8gZGVsdGFUaW1lKTsKICAgICAgdmFyIGFuZ2xlID0gVHlwaW5nRE5BLm1vdXNlLmdldEFuZ2xlKHhQb3NEZWx0YSwgeVBvc0RlbHRhKTsKICAgICAgdmFyIGV2ZW50VHlwZSA9IGRyYWcgPT09IHRydWUgPyA1IDogMTsKICAgICAgdmFyIGFyciA9IFtldmVudFR5cGUsIGRlbHRhVGltZSwgZGlyZWN0RGlzdGFuY2UsIHNwZWVkLCBhbmdsZSwgcmF0aW9EaXN0YW5jZSxdOwogICAgICB2YXIgYXJyTGVuID0gYXJyLmxlbmd0aDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJMZW47IGkrKykgewogICAgICAgIGlmIChpc05hTihhcnJbaV0pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICAgIFR5cGluZ0ROQS5tb3VzZS5oaXN0b3J5LmFkZChhcnIpOwogICAgICBUeXBpbmdETkEubGFzdE1vdXNlU3RvcCA9IGZhbHNlOwogICAgfQoKICAgIFR5cGluZ0ROQS5tb3VzZS5yZWNvcmRTY3JvbGxBY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxlbmd0aCA9IFR5cGluZ0ROQS5tb3VzZS5zY3JvbGxUaW1lcy5sZW5ndGg7CiAgICAgIGlmIChsZW5ndGggPCAyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBkZWx0YVRpbWUgPSBUeXBpbmdETkEubW91c2Uuc2Nyb2xsVGltZXNbbGVuZ3RoIC0gMV0gLSBUeXBpbmdETkEubW91c2Uuc2Nyb2xsVGltZXNbMF07CiAgICAgIHZhciBkaXJlY3REaXN0YW5jZSA9IFR5cGluZ0ROQS5tb3VzZS5zY3JvbGxUb3BBcnJbbGVuZ3RoIC0gMV0gLSBUeXBpbmdETkEubW91c2Uuc2Nyb2xsVG9wQXJyWzBdOwogICAgICB2YXIgc3BlZWQgPSBNYXRoLnJvdW5kKGRpcmVjdERpc3RhbmNlICogMTAwIC8gZGVsdGFUaW1lKTsKICAgICAgdmFyIGV2ZW50VHlwZSA9IDI7CiAgICAgIHZhciBhcnIgPSBbZXZlbnRUeXBlLCBkZWx0YVRpbWUsIGRpcmVjdERpc3RhbmNlLCBzcGVlZCxdOwogICAgICB2YXIgYXJyTGVuID0gYXJyLmxlbmd0aDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJMZW47IGkrKykgewogICAgICAgIGlmIChpc05hTihhcnJbaV0pICYmICFpc0Zpbml0ZShhcnJbaV0pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICAgIFR5cGluZ0ROQS5tb3VzZS5oaXN0b3J5LmFkZChhcnIpOwogICAgfQoKICAgIFR5cGluZ0ROQS5tb3VzZS5oaXN0b3J5LmFkZCA9IGZ1bmN0aW9uKGFycikgewogICAgICB0aGlzLnN0YWNrLnB1c2goYXJyKTsKICAgICAgaWYgKHRoaXMuc3RhY2subGVuZ3RoID4gVHlwaW5nRE5BLm1heE1vdXNlSGlzdG9yeUxlbmd0aCkgewogICAgICAgIHRoaXMuc3RhY2suc2hpZnQoKTsKICAgICAgfQogICAgfQoKICAgIFR5cGluZ0ROQS5tb3VzZS5oaXN0b3J5LmdldERpYWdyYW0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG1vdXNlRGlhZ3JhbSA9IHRoaXMuc3RhY2suam9pbignfCcpOwogICAgICB2YXIgZGlhZ3JhbVR5cGUgPSA5OyAvLyBmb3IgbW91c2UgZGlhZ3JhbQogICAgICByZXR1cm4gW1N0cmluZyhUeXBpbmdETkEuaXNNb2JpbGUoKSkgKyAnLCcgKyBTdHJpbmcoVHlwaW5nRE5BLnZlcnNpb24pICsgJywnICsgVHlwaW5nRE5BLmZsYWdzICsgJywnICsgZGlhZ3JhbVR5cGUgKyAnLDAsMCwnICsgVHlwaW5nRE5BLmdldFNwZWNpYWxLZXlzKCkgKwogICAgICAgICcsJyArIFR5cGluZ0ROQS5nZXREZXZpY2VTaWduYXR1cmUoKSwgbW91c2VEaWFncmFtCiAgICAgIF0uam9pbignfCcpOwogICAgfQoKICAgIFR5cGluZ0ROQS5tb3VzZS5jbGVhckxhc3RNb3ZlID0gZnVuY3Rpb24oKSB7CiAgICAgIFR5cGluZ0ROQS5tb3VzZS50aW1lcyA9IFtdOwogICAgICBUeXBpbmdETkEubW91c2UueFBvc2l0aW9ucyA9IFtdOwogICAgICBUeXBpbmdETkEubW91c2UueVBvc2l0aW9ucyA9IFtdOwogICAgfQoKICAgIFR5cGluZ0ROQS5tb3VzZS5jaGVja01vdmUgPSBmdW5jdGlvbihkcmFnKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwoVHlwaW5nRE5BLm1vdmVJbnRlcnZhbCk7CiAgICAgIGlmIChUeXBpbmdETkEubW91c2Uuc3RhcnRlZCA9PT0gdHJ1ZSkgewogICAgICAgIFR5cGluZ0ROQS5tb3VzZS5zdGFydGVkID0gZmFsc2U7CiAgICAgICAgVHlwaW5nRE5BLm1vdXNlLnJlY29yZE1vdmVBY3Rpb24oZHJhZyk7CiAgICAgICAgVHlwaW5nRE5BLm1vdXNlLmNsZWFyTGFzdE1vdmUoKTsKICAgICAgfQogICAgfQoKICAgIFR5cGluZ0ROQS5tb3VzZS5jbGVhckxhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKICAgICAgVHlwaW5nRE5BLm1vdXNlLnNjcm9sbFRpbWVzID0gW107CiAgICAgIFR5cGluZ0ROQS5tb3VzZS5zY3JvbGxUb3BBcnIgPSBbXTsKICAgIH0KCiAgICBUeXBpbmdETkEubW91c2UuY2hlY2tTY3JvbGwgPSBmdW5jdGlvbigpIHsKICAgICAgY2xlYXJJbnRlcnZhbChUeXBpbmdETkEuc2Nyb2xsSW50ZXJ2YWwpOwogICAgICBpZiAoVHlwaW5nRE5BLm1vdXNlLnNjcm9sbFN0YXJ0ZWQgPT09IHRydWUpIHsKICAgICAgICBUeXBpbmdETkEubW91c2Uuc2Nyb2xsU3RhcnRlZCA9IGZhbHNlOwogICAgICAgIFR5cGluZ0ROQS5tb3VzZS5yZWNvcmRTY3JvbGxBY3Rpb24oKTsKICAgICAgICBUeXBpbmdETkEubW91c2UuY2xlYXJMYXN0U2Nyb2xsKCk7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEFkZHMgYSB0YXJnZXQgdG8gdGhlIHRhcmdldElkcyBhcnJheS4KICAgICAqLwogICAgVHlwaW5nRE5BLmFkZFRhcmdldCA9IGZ1bmN0aW9uKHRhcmdldCkgewogICAgICB2YXIgdGFyZ2V0TGVuZ3RoID0gVHlwaW5nRE5BLnRhcmdldElkcy5sZW5ndGg7CiAgICAgIHZhciB0YXJnZXRGb3VuZCA9IGZhbHNlOwogICAgICBpZiAodGFyZ2V0TGVuZ3RoID4gMCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGFyZ2V0TGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChUeXBpbmdETkEudGFyZ2V0SWRzW2ldID09PSB0YXJnZXQpIHsKICAgICAgICAgICAgdGFyZ2V0Rm91bmQgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0YXJnZXRGb3VuZCkgewogICAgICAgICAgVHlwaW5nRE5BLnRhcmdldElkcy5wdXNoKHRhcmdldCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIFR5cGluZ0ROQS50YXJnZXRJZHMucHVzaCh0YXJnZXQpOwogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGRzIGEgdGFyZ2V0IHRvIHRoZSB0YXJnZXRJZHMgYXJyYXkuCiAgICAgKi8KICAgIFR5cGluZ0ROQS5yZW1vdmVUYXJnZXQgPSBmdW5jdGlvbih0YXJnZXQpIHsKICAgICAgdmFyIHRhcmdldExlbmd0aCA9IFR5cGluZ0ROQS50YXJnZXRJZHMubGVuZ3RoOwogICAgICBpZiAodGFyZ2V0TGVuZ3RoID4gMCkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGFyZ2V0TGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChUeXBpbmdETkEudGFyZ2V0SWRzW2ldID09PSB0YXJnZXQpIHsKICAgICAgICAgICAgVHlwaW5nRE5BLnRhcmdldElkcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmVzZXRzIHRoZSBoaXN0b3J5IHN0YWNrCiAgICAgKi8KICAgIFR5cGluZ0ROQS5yZXNldCA9IGZ1bmN0aW9uKGFsbCkgewogICAgICBUeXBpbmdETkEuaGlzdG9yeS5zdGFjayA9IFtdOwogICAgICBUeXBpbmdETkEuaGlzdG9yeS5zdGFja0RpYWdyYW0gPSBbXTsKICAgICAgVHlwaW5nRE5BLmNsaWNrVGltZXMgPSBbXTsKICAgICAgVHlwaW5nRE5BLnN0b3BUaW1lcyA9IFtdOwogICAgICBUeXBpbmdETkEuQUNJbnB1dExlbmd0aHMgPSB7CiAgICAgICAgaW5wdXRzOiBbXSwKICAgICAgICBsYXN0TGVuZ3RoOiBbXSwKICAgICAgfTsKICAgICAgaWYgKGFsbCA9PT0gdHJ1ZSkgewogICAgICAgIFR5cGluZ0ROQS5tb3VzZS5oaXN0b3J5LnN0YWNrID0gW107CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEF1dG9tYXRpY2FsbHkgY2FsbGVkIGF0IGluaXRpbGl6YXRpb24uIEl0IHN0YXJ0cyB0aGUgcmVjb3JkaW5nIG9mIGtleXN0cm9rZXMuCiAgICAgKi8KICAgIFR5cGluZ0ROQS5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICBUeXBpbmdETkEuZGlhZ3JhbVJlY29yZGluZyA9IHRydWU7CiAgICAgIHJldHVybiBUeXBpbmdETkEucmVjb3JkaW5nID0gdHJ1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEVuZHMgdGhlIHJlY29yZGluZyBvZiBmdXJ0aGVyIGtleXN0cm9rZXMuIFRvIHJlc3RhcnQgcmVjb3JkaW5nIGFmdGVyd2FyZHMgeW91IGNhbgogICAgICogZWl0aGVyIGNhbGwgVHlwaW5nRE5BLnN0YXJ0KCkgb3IgY3JlYXRlIGEgbmV3IFR5cGluZ0ROQSBvYmplY3QgYWdhaW4sIG5vdCByZWNvbW1lbmRlZC4KICAgICAqLwogICAgVHlwaW5nRE5BLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgVHlwaW5nRE5BLmRpYWdyYW1SZWNvcmRpbmcgPSBmYWxzZTsKICAgICAgcmV0dXJuIFR5cGluZ0ROQS5yZWNvcmRpbmcgPSBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIFN0YXJ0cyB0aGUgcmVjb3JkaW5nIG9mIG1vdXNlIGFjdGl2aXR5LgogICAgICovCiAgICBUeXBpbmdETkEuc3RhcnRNb3VzZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gVHlwaW5nRE5BLm1vdXNlUmVjb3JkaW5nID0gVHlwaW5nRE5BLm1vdXNlTW92ZVJlY29yZGluZyA9IHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBTdG9wcyB0aGUgcmVjb3JkaW5nIG9mIG1vdXNlIGFjdGl2aXR5LgogICAgICovCiAgICBUeXBpbmdETkEuc3RvcE1vdXNlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBUeXBpbmdETkEubW91c2VSZWNvcmRpbmcgPSBUeXBpbmdETkEubW91c2VNb3ZlUmVjb3JkaW5nID0gZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXNldHMgbW91c2UgcmVjb3JkaW5nCiAgICAgKi8KICAgIFR5cGluZ0ROQS5yZXNldE1vdXNlID0gZnVuY3Rpb24oYWxsKSB7CiAgICAgIGlmIChhbGwgPT09IHRydWUpIHsKICAgICAgICBUeXBpbmdETkEuY2xpY2tUaW1lcyA9IFtdOwogICAgICAgIFR5cGluZ0ROQS5zdG9wVGltZXMgPSBbXTsKICAgICAgfQogICAgICBUeXBpbmdETkEubW91c2UuaGlzdG9yeS5zdGFjayA9IFtdOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBpcyB0aGUgbWFpbiBmdW5jdGlvbiB0aGF0IG91dHB1dHMgdGhlIHR5cGluZyBwYXR0ZXJuIGFzIGEgU3RyaW5nCiAgICAgKiB7dHlwZTpOdW1iZXIsIHRleHQ6U3RyaW5nLCB0ZXh0SWQ6TnVtYmVyLCBsZW5ndGg6IE51bWJlciwgdGFyZ2V0SWQ6U3RyaW5nLCBjYXNlU2Vuc2l0aXZlOkJvb2xlYW59CiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqIGFuIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllcwogICAgICogKiAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIDAgZm9yIGFueXRleHQgcGF0dGVybiwgMSBmb3Igc2FtZXRleHQgcGF0dGVybiAoYWxzbyBjYWxsZWQgZGlhZ3JhbSBwYXR0ZXJuKQogICAgICogKiAqIGFuZCAyIGZvciBleHRlbmRlZCBwYXR0ZXJuIChtb3N0IHZlcnNhdGlsZSwgY2FuIHJlcGxhY2UgYm90aCBhbnl0ZXh0IGFuZCBzYW1ldGV4dCBwYXR0ZXJucykKICAgICAqICogKiBAcGFyYW0ge051bWJlcn0gbGVuZ3RoIChPcHRpb25hbCkgdGhlIGxlbmd0aCBvZiB0aGUgdGV4dCBpbiB0aGUgaGlzdG9yeSBmb3Igd2hpY2ggeW91IHdhbnQKICAgICAqICogKiB0aGUgdHlwaW5nIHBhdHRlcm4uIGxlbmd0aCBpcyBpZ25vcmVkIHdoZW4gdGV4dCBvciB0YXJnZXRJZCBpcyBzZXQgKG9yIGJvdGgpLgogICAgICogKiAqIEBwYXJhbSB7U3RyaW5nfSB0ZXh0ICAoT25seSBmb3IgdHlwZSAxIGFuZCB0eXBlIDIpIGEgdHlwZWQgc3RyaW5nIHRoYXQgeW91IHdhbnQgdGhlIHR5cGluZyBwYXR0ZXJuIGZvcgogICAgICogKiAqIEBwYXJhbSB7TnVtYmVyfSB0ZXh0SWQgKE9wdGlvbmFsLCBvbmx5IGZvciB0eXBlIDEgYW5kIHR5cGUgMikgYSBwZXJzb25hbGl6ZWQgaWQgZm9yIHRoZSB0eXBlZCB0ZXh0CiAgICAgKiAqICogQHBhcmFtIHtTdHJpbmd9IHRhcmdldElkIChPcHRpb25hbCkgc3BlY2lmaWVzIGlmIHBhdHRlcm4gaXMgb2J0YWluIG9ubHkgZnJvbSB0ZXh0IHR5cGVkIGluIGEgY2VydGFpbiB0YXJnZXQKICAgICAqICogKiBAcGFyYW0ge0Jvb2xlYW59IGNhc2VTZW5zaXRpdmUgKE9wdGlvbmFsLCBkZWZhdWx0OiBmYWxzZSkgVXNlZCBpZiB5b3UgcGFzcyBhIHRleHQgZm9yIHR5cGUgMSBvciB0eXBlIDIKICAgICAqICogKiBERVBSRUNBVEVEICogKiAqIGluIGZhdm9yIG9mIHR5cGUgPSAyICogKiAqCiAgICAgKiAqICogQHBhcmFtIHtCb29sZWFufSBleHRlbmRlZCAoT25seSBmb3IgdHlwZSAxKSBzcGVjaWZpZXMgaWYgZnVsbCBpbmZvcm1hdGlvbiBhYm91dCB3aGF0IHdhcyB0eXBlZCBpcyBwcm9kdWNlZCwKICAgICAqICogKiBpbmNsdWRpbmcgdGhlIGFjdHVhbCBrZXkgcHJlc3NlZCwgaWYgZmFsc2UsIG9ubHkgdGhlIG9yZGVyIG9mIHByZXNzZWQga2V5cyBpcyBrZXB0IChubyBhY3R1YWwgY29udGVudCkKICAgICAqIEByZXR1cm4ge1N0cmluZ30gQSB0eXBpbmcgcGF0dGVybiBpbiBzdHJpbmcgZm9ybQogICAgICogQGV4YW1wbGUgdmFyIHR5cGluZ1BhdHRlcm4gPSB0ZG5hLmdldFR5cGluZ1BhdHRlcm4oe3R5cGU6MCwgbGVuZ3RoOjE4MH0pOwogICAgICogQGV4YW1wbGUgdmFyIHR5cGluZ1BhdHRlcm4gPSB0ZG5hLmdldFR5cGluZ1BhdHRlcm4oe3R5cGU6MSwgdGV4dDoiSGVsbG81ZzIxPyoifSk7CiAgICAgKiBAZXhhbXBsZSB2YXIgdHlwaW5nUGF0dGVybiA9IHRkbmEuZ2V0VHlwaW5nUGF0dGVybih7dHlwZToyLCB0ZXh0OiJleGFtcGxlQG1haWwuY29tIn0pOwogICAgICovCiAgICBUeXBpbmdETkEuZ2V0VHlwaW5nUGF0dGVybiA9IGZ1bmN0aW9uKG9iaikgewogICAgICB2YXIgc3RyID0gJyc7CiAgICAgIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JykgewogICAgICAgIHN3aXRjaCAob2JqLnR5cGUpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgcmV0dXJuIFR5cGluZ0ROQS5nZXQob2JqLmxlbmd0aCwgb2JqLnRhcmdldElkKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIHN0ciA9IChvYmoudGV4dCAhPT0gdW5kZWZpbmVkKSA/IG9iai50ZXh0IDogb2JqLmxlbmd0aDsKICAgICAgICAgICAgcmV0dXJuIFR5cGluZ0ROQS5oaXN0b3J5LmdldERpYWdyYW0ob2JqLmV4dGVuZGVkLCBzdHIsIG9iai50ZXh0SWQsIG9iai50YXJnZXRJZCwgb2JqLmNhc2VTZW5zaXRpdmUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgc3RyID0gKG9iai50ZXh0ICE9PSB1bmRlZmluZWQpID8gb2JqLnRleHQgOiBvYmoubGVuZ3RoOwogICAgICAgICAgICByZXR1cm4gVHlwaW5nRE5BLmhpc3RvcnkuZ2V0RGlhZ3JhbSh0cnVlLCBzdHIsIG9iai50ZXh0SWQsIG9iai50YXJnZXRJZCwgb2JqLmNhc2VTZW5zaXRpdmUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHJldHVybiBUeXBpbmdETkEuZ2V0KG9iai5sZW5ndGgpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIFR5cGluZ0ROQS5nZXQoKTsKICAgICAgfQogICAgfQoKICAgIFR5cGluZ0ROQS5nZXREaWFncmFtID0gZnVuY3Rpb24oc3RyLCB0ZXh0SWQpIHsKICAgICAgcmV0dXJuIFR5cGluZ0ROQS5oaXN0b3J5LmdldERpYWdyYW0oZmFsc2UsIHN0ciwgdGV4dElkLCB1bmRlZmluZWQsIGZhbHNlKTsKICAgIH0KCiAgICBUeXBpbmdETkEuZ2V0RXh0ZW5kZWREaWFncmFtID0gZnVuY3Rpb24oc3RyLCB0ZXh0SWQpIHsKICAgICAgcmV0dXJuIFR5cGluZ0ROQS5oaXN0b3J5LmdldERpYWdyYW0odHJ1ZSwgc3RyLCB0ZXh0SWQsIHVuZGVmaW5lZCwgZmFsc2UpOwogICAgfQoKICAgIFR5cGluZ0ROQS5nZXRNb3VzZURpYWdyYW0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFR5cGluZ0ROQS5tb3VzZS5oaXN0b3J5LmdldERpYWdyYW0oKTsKICAgIH0KICAgIFR5cGluZ0ROQS5nZXRTcGVjaWFsS2V5cyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gVHlwaW5nRE5BLmhpc3RvcnkuZ2V0U3BlY2lhbEtleXMoKTsKICAgIH0KCiAgICBUeXBpbmdETkEuZ2V0ID0gZnVuY3Rpb24obGVuZ3RoLCB0YXJnZXRJZCkgewogICAgICB2YXIgaGlzdG9yeVRvdGFsTGVuZ3RoID0gVHlwaW5nRE5BLmhpc3Rvcnkuc3RhY2subGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQgfHwgbGVuZ3RoID09PSAwKSB7CiAgICAgICAgbGVuZ3RoID0gVHlwaW5nRE5BLmRlZmF1bHRIaXN0b3J5TGVuZ3RoOwogICAgICB9CiAgICAgIGlmIChsZW5ndGggPiBoaXN0b3J5VG90YWxMZW5ndGgpIHsKICAgICAgICBsZW5ndGggPSBoaXN0b3J5VG90YWxMZW5ndGg7CiAgICAgIH0KICAgICAgdmFyIG9iaiA9IHt9OwogICAgICB2YXIgdGFyZ2V0TGVuZ3RoOwogICAgICBbb2JqLmFyciwgdGFyZ2V0TGVuZ3RoXSA9IFR5cGluZ0ROQS5oaXN0b3J5LmdldChsZW5ndGgsICIiLCB0YXJnZXRJZCk7CiAgICAgIGlmICh0YXJnZXRJZCAhPT0gdW5kZWZpbmVkICYmIHRhcmdldElkICE9PSAiIikgewogICAgICAgIGxlbmd0aCA9IHRhcmdldExlbmd0aDsKICAgICAgfQogICAgICB2YXIgemwgPSBUeXBpbmdETkEuemw7CiAgICAgIHZhciBoaXN0UmV2ID0gbGVuZ3RoOwogICAgICB2YXIgaGlzdFNrdEYgPSBUeXBpbmdETkEubWF0aC5mbyhUeXBpbmdETkEuaGlzdG9yeS5nZXQobGVuZ3RoLCAic2VlayIsIHRhcmdldElkKSk7CiAgICAgIHZhciBoaXN0UHJ0RiA9IFR5cGluZ0ROQS5tYXRoLmZvKFR5cGluZ0ROQS5oaXN0b3J5LmdldChsZW5ndGgsICJwcmVzcyIsIHRhcmdldElkKSk7CiAgICAgIHZhciBwcmVzc0hpc3RNZWFuID0gTWF0aC5yb3VuZChUeXBpbmdETkEubWF0aC5hdmcoaGlzdFBydEYpKTsKICAgICAgdmFyIHNlZWtIaXN0TWVhbiA9IE1hdGgucm91bmQoVHlwaW5nRE5BLm1hdGguYXZnKGhpc3RTa3RGKSk7CiAgICAgIHZhciBwcmVzc0hpc3RTRCA9IE1hdGgucm91bmQoVHlwaW5nRE5BLm1hdGguc2QoaGlzdFBydEYpKTsKICAgICAgdmFyIHNlZWtIaXN0U0QgPSBNYXRoLnJvdW5kKFR5cGluZ0ROQS5tYXRoLnNkKGhpc3RTa3RGKSk7CiAgICAgIHZhciBjaGFyTWVhblRpbWUgPSBzZWVrSGlzdE1lYW4gKyBwcmVzc0hpc3RNZWFuOwogICAgICB2YXIgcHJlc3NSYXRpbyA9IFR5cGluZ0ROQS5tYXRoLnJkKChwcmVzc0hpc3RNZWFuICsgemwpIC8gKGNoYXJNZWFuVGltZSArIHpsKSwgNCk7CiAgICAgIHZhciBzZWVrVG9QcmVzc1JhdGlvID0gVHlwaW5nRE5BLm1hdGgucmQoKDEgLSBwcmVzc1JhdGlvKSAvIHByZXNzUmF0aW8sIDQpOwogICAgICB2YXIgcHJlc3NTRFRvUHJlc3NSYXRpbyA9IFR5cGluZ0ROQS5tYXRoLnJkKChwcmVzc0hpc3RTRCArIHpsKSAvIChwcmVzc0hpc3RNZWFuICsgemwpLCA0KTsKICAgICAgdmFyIHNlZWtTRFRvUHJlc3NSYXRpbyA9IFR5cGluZ0ROQS5tYXRoLnJkKChzZWVrSGlzdFNEICsgemwpIC8gKHByZXNzSGlzdE1lYW4gKyB6bCksIDQpOwogICAgICB2YXIgY3BtID0gTWF0aC5yb3VuZCg2RTQgLyAoY2hhck1lYW5UaW1lICsgemwpKTsKICAgICAgaWYgKGhpc3RSZXYgPT09IDApIHsKICAgICAgICBjcG0gPSAwOwogICAgICB9CiAgICAgIHZhciBhcnIgPSBbXTsKICAgICAgZm9yICh2YXIgaSBpbiBvYmouYXJyKSB7CiAgICAgICAgdmFyIHJldiA9IG9iai5hcnJbaV1bMV0ubGVuZ3RoOwogICAgICAgIHZhciBzZWVrTWVhbiA9IDA7CiAgICAgICAgdmFyIHByZXNzTWVhbiA9IDA7CiAgICAgICAgdmFyIHBvc3RNZWFuID0gMDsKICAgICAgICB2YXIgc2Vla1NEID0gMDsKICAgICAgICB2YXIgcHJlc3NTRCA9IDA7CiAgICAgICAgdmFyIHBvc3RTRCA9IDA7CiAgICAgICAgc3dpdGNoIChvYmouYXJyW2ldWzBdLmxlbmd0aCkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgc2Vla01lYW4gPSBUeXBpbmdETkEubWF0aC5yZCgob2JqLmFycltpXVswXVswXSArIHpsKSAvIChzZWVrSGlzdE1lYW4gKyB6bCksIDQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGFyciA9IFR5cGluZ0ROQS5tYXRoLmZvKG9iai5hcnJbaV1bMF0pOwogICAgICAgICAgICBzZWVrTWVhbiA9IFR5cGluZ0ROQS5tYXRoLnJkKChUeXBpbmdETkEubWF0aC5hdmcoYXJyKSArIHpsKSAvIChzZWVrSGlzdE1lYW4gKyB6bCksIDQpOwogICAgICAgICAgICBzZWVrU0QgPSBUeXBpbmdETkEubWF0aC5yZCgoVHlwaW5nRE5BLm1hdGguc2QoYXJyKSArIHpsKSAvIChzZWVrSGlzdFNEICsgemwpLCA0KTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoIChvYmouYXJyW2ldWzFdLmxlbmd0aCkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcHJlc3NNZWFuID0gVHlwaW5nRE5BLm1hdGgucmQoKG9iai5hcnJbaV1bMV1bMF0gKyB6bCkgLyAocHJlc3NIaXN0TWVhbiArIHpsKSwgNCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgYXJyID0gVHlwaW5nRE5BLm1hdGguZm8ob2JqLmFycltpXVsxXSk7CiAgICAgICAgICAgIHByZXNzTWVhbiA9IFR5cGluZ0ROQS5tYXRoLnJkKChUeXBpbmdETkEubWF0aC5hdmcoYXJyKSArIHpsKSAvIChwcmVzc0hpc3RNZWFuICsgemwpLCA0KTsKICAgICAgICAgICAgcHJlc3NTRCA9IFR5cGluZ0ROQS5tYXRoLnJkKChUeXBpbmdETkEubWF0aC5zZChhcnIpICsgemwpIC8gKHByZXNzSGlzdFNEICsgemwpLCA0KTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoIChvYmouYXJyW2ldWzJdLmxlbmd0aCkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgcG9zdE1lYW4gPSBUeXBpbmdETkEubWF0aC5yZCgob2JqLmFycltpXVsyXVswXSArIHpsKSAvIChzZWVrSGlzdE1lYW4gKyB6bCksIDQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGFyciA9IFR5cGluZ0ROQS5tYXRoLmZvKG9iai5hcnJbaV1bMl0pOwogICAgICAgICAgICBwb3N0TWVhbiA9IFR5cGluZ0ROQS5tYXRoLnJkKChUeXBpbmdETkEubWF0aC5hdmcoYXJyKSArIHpsKSAvIChzZWVrSGlzdE1lYW4gKyB6bCksIDQpOwogICAgICAgICAgICBwb3N0U0QgPSBUeXBpbmdETkEubWF0aC5yZCgoVHlwaW5nRE5BLm1hdGguc2QoYXJyKSArIHpsKSAvIChzZWVrSGlzdFNEICsgemwpLCA0KTsKICAgICAgICB9CiAgICAgICAgZGVsZXRlIG9iai5hcnJbaV1bMl07CiAgICAgICAgZGVsZXRlIG9iai5hcnJbaV1bMV07CiAgICAgICAgZGVsZXRlIG9iai5hcnJbaV1bMF07CiAgICAgICAgb2JqLmFycltpXVswXSA9IHJldjsKICAgICAgICBvYmouYXJyW2ldWzFdID0gc2Vla01lYW47CiAgICAgICAgb2JqLmFycltpXVsyXSA9IHByZXNzTWVhbjsKICAgICAgICBvYmouYXJyW2ldWzNdID0gcG9zdE1lYW47CiAgICAgICAgb2JqLmFycltpXVs0XSA9IHNlZWtTRDsKICAgICAgICBvYmouYXJyW2ldWzVdID0gcHJlc3NTRDsKICAgICAgICBvYmouYXJyW2ldWzZdID0gcG9zdFNEOwogICAgICB9CiAgICAgIGFyciA9IFtdOwogICAgICBUeXBpbmdETkEuYXB1KGFyciwgaGlzdFJldik7CiAgICAgIFR5cGluZ0ROQS5hcHUoYXJyLCBjcG0pOwogICAgICBUeXBpbmdETkEuYXB1KGFyciwgY2hhck1lYW5UaW1lKTsKICAgICAgVHlwaW5nRE5BLmFwdShhcnIsIHByZXNzUmF0aW8pOwogICAgICBUeXBpbmdETkEuYXB1KGFyciwgc2Vla1RvUHJlc3NSYXRpbyk7CiAgICAgIFR5cGluZ0ROQS5hcHUoYXJyLCBwcmVzc1NEVG9QcmVzc1JhdGlvKTsKICAgICAgVHlwaW5nRE5BLmFwdShhcnIsIHNlZWtTRFRvUHJlc3NSYXRpbyk7CiAgICAgIFR5cGluZ0ROQS5hcHUoYXJyLCBwcmVzc0hpc3RNZWFuKTsKICAgICAgVHlwaW5nRE5BLmFwdShhcnIsIHNlZWtIaXN0TWVhbik7CiAgICAgIFR5cGluZ0ROQS5hcHUoYXJyLCBwcmVzc0hpc3RTRCk7CiAgICAgIFR5cGluZ0ROQS5hcHUoYXJyLCBzZWVrSGlzdFNEKTsKICAgICAgZm9yICh2YXIgYyA9IDA7IGMgPD0gNjsgYysrKSB7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IDQ0OyBpKyspIHsKICAgICAgICAgIHZhciBrZXlDb2RlID0gVHlwaW5nRE5BLmtleUNvZGVzW2ldOwogICAgICAgICAgdmFyIHZhbCA9IG9iai5hcnJba2V5Q29kZV1bY107CiAgICAgICAgICBpZiAodmFsID09PSAwICYmIGMgPiAwKSB7CiAgICAgICAgICAgIHZhbCA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBUeXBpbmdETkEuYXB1KGFyciwgdmFsKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgVHlwaW5nRE5BLmFwdShhcnIsIFR5cGluZ0ROQS5pc01vYmlsZSgpKTsKICAgICAgVHlwaW5nRE5BLmFwdShhcnIsIFR5cGluZ0ROQS52ZXJzaW9uKTsKICAgICAgVHlwaW5nRE5BLmFwdShhcnIsIFR5cGluZ0ROQS5mbGFncyk7CiAgICAgIFR5cGluZ0ROQS5hcHUoYXJyLCAtMSk7IC8vIGRpYWdyYW1UeXBlCiAgICAgIFR5cGluZ0ROQS5hcHUoYXJyLCBoaXN0UmV2KTsKICAgICAgVHlwaW5nRE5BLmFwdShhcnIsIDApOyAvLyB0ZXh0SWQKICAgICAgYXJyLnB1c2goVHlwaW5nRE5BLmdldFNwZWNpYWxLZXlzKCkpOwogICAgICBhcnIucHVzaChUeXBpbmdETkEuZ2V0RGV2aWNlU2lnbmF0dXJlKCkpOwogICAgICByZXR1cm4gYXJyLmpvaW4oIiwiKTsKICAgIH0KCiAgICBUeXBpbmdETkEuYXB1ID0gZnVuY3Rpb24oYXJyLCB2YWwpIHsKICAgICAgIk5hTiIgPT09IFN0cmluZyh2YWwpICYmICh2YWwgPSAwKTsKICAgICAgYXJyLnB1c2godmFsKTsKICAgIH0KCiAgICBUeXBpbmdETkEubWF0aCA9IHt9OwoKICAgIFR5cGluZ0ROQS5tYXRoLnJkID0gZnVuY3Rpb24odmFsLCBkZWMpIHsKICAgICAgcmV0dXJuIE51bWJlcih2YWwudG9GaXhlZChkZWMpKTsKICAgIH0KCiAgICBUeXBpbmdETkEubWF0aC5hdmcgPSBmdW5jdGlvbihhcnIpIHsKICAgICAgdmFyIGxlbiA9IGFyci5sZW5ndGg7CiAgICAgIGlmIChsZW4gPiAwKSB7CiAgICAgICAgdmFyIHN1bSA9IDA7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgc3VtICs9IGFycltpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMucmQoc3VtIC8gbGVuLCA0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgfQoKICAgIFR5cGluZ0ROQS5tYXRoLnNkID0gZnVuY3Rpb24oYXJyKSB7CiAgICAgIHZhciBsZW4gPSBhcnIubGVuZ3RoOwogICAgICBpZiAobGVuIDwgMikgewogICAgICAgIHJldHVybiAwOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBzdW1WUyA9IDA7CiAgICAgICAgdmFyIG1lYW4gPSB0aGlzLmF2ZyhhcnIpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIHN1bVZTICs9IChhcnJbaV0gLSBtZWFuKSAqIChhcnJbaV0gLSBtZWFuKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNkID0gTWF0aC5zcXJ0KHN1bVZTIC8gbGVuKTsKICAgICAgICByZXR1cm4gc2Q7CiAgICAgIH0KICAgIH0KCiAgICBUeXBpbmdETkEubWF0aC5mbyA9IGZ1bmN0aW9uKGFycikgewogICAgICBpZiAoYXJyLmxlbmd0aCA+IDEpIHsKICAgICAgICB2YXIgdmFsdWVzID0gYXJyLmNvbmNhdCgpOwogICAgICAgIHZhciBsZW4gPSBhcnIubGVuZ3RoOwogICAgICAgIHZhbHVlcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhIC0gYjsKICAgICAgICB9KTsKICAgICAgICB2YXIgYXNkID0gdGhpcy5zZCh2YWx1ZXMpOwogICAgICAgIHZhciBhTWVhbiA9IHZhbHVlc1tNYXRoLmNlaWwoYXJyLmxlbmd0aCAvIDIpXTsKICAgICAgICB2YXIgbXVsdGlwbGllciA9IDI7CiAgICAgICAgdmFyIG1heFZhbCA9IGFNZWFuICsgbXVsdGlwbGllciAqIGFzZDsKICAgICAgICB2YXIgbWluVmFsID0gYU1lYW4gLSBtdWx0aXBsaWVyICogYXNkOwogICAgICAgIGlmIChsZW4gPCAyMCkgewogICAgICAgICAgbWluVmFsID0gMDsKICAgICAgICB9CiAgICAgICAgdmFyIGZWYWwgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICB2YXIgdGVtcHZhbCA9IHZhbHVlc1tpXTsKICAgICAgICAgIGlmICh0ZW1wdmFsIDwgbWF4VmFsICYmIHRlbXB2YWwgPiBtaW5WYWwpIHsKICAgICAgICAgICAgZlZhbC5wdXNoKHRlbXB2YWwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZlZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gYXJyOwogICAgICB9CiAgICB9CgogICAgLy8gQ2FsY3VsYXRlIGEgMzIgYml0IEZOVi0xYSBoYXNoCiAgICBUeXBpbmdETkEubWF0aC5mbnYxYUhhc2ggPSBmdW5jdGlvbihzdHIpIHsKICAgICAgaWYgKHN0ciA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiBzdHIgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgICAgc3RyID0gc3RyLnRvTG93ZXJDYXNlKCk7CiAgICAgIHZhciBpLCBsOwogICAgICB2YXIgaHZhbCA9IDB4NzIxYjVhZDQ7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBzdHIubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaHZhbCBePSBzdHIuY2hhckNvZGVBdChpKTsKICAgICAgICBodmFsICs9IChodmFsIDw8IDEpICsgKGh2YWwgPDwgNCkgKyAoaHZhbCA8PCA3KSArIChodmFsIDw8IDgpICsgKGh2YWwgPDwgMjQpOwogICAgICB9CiAgICAgIHJldHVybiBodmFsID4+PiAwOwogICAgfQoKICAgIFR5cGluZ0ROQS5oaXN0b3J5ID0ge307CiAgICBUeXBpbmdETkEuaGlzdG9yeS5zdGFjayA9IFtdOwogICAgVHlwaW5nRE5BLmhpc3Rvcnkuc3RhY2tEaWFncmFtID0gW107CgogICAgVHlwaW5nRE5BLmhpc3RvcnkuYWRkID0gZnVuY3Rpb24oYXJyKSB7CiAgICAgIHRoaXMuc3RhY2sucHVzaChhcnIpOwogICAgICBpZiAodGhpcy5zdGFjay5sZW5ndGggPiBUeXBpbmdETkEubWF4SGlzdG9yeUxlbmd0aCkgewogICAgICAgIHRoaXMuc3RhY2suc2hpZnQoKTsKICAgICAgfQogICAgfQoKICAgIFR5cGluZ0ROQS5oaXN0b3J5LmFkZERpYWdyYW0gPSBmdW5jdGlvbihhcnIpIHsKICAgICAgdGhpcy5zdGFja0RpYWdyYW0ucHVzaChhcnIpOwogICAgfQoKICAgIFR5cGluZ0ROQS5oaXN0b3J5LmdldERpYWdyYW0gPSBmdW5jdGlvbihleHRlbmRlZCwgc3RyLCB0ZXh0SWQsIHRhcmdldElkLCBjYXNlU2Vuc2l0aXZlKSB7CiAgICAgIGNhc2VTZW5zaXRpdmUgPSAoY2FzZVNlbnNpdGl2ZSAhPT0gdW5kZWZpbmVkKSA/IGNhc2VTZW5zaXRpdmUgOiAoc3RyID09PSB1bmRlZmluZWQgfHwgc3RyID09PSAiIik7CiAgICAgIHZhciByZXR1cm5BcnIgPSBbXTsKICAgICAgdmFyIG1vdGlvbkFyciA9IFtdOwogICAgICB2YXIga3B6YUFyciA9IFtdOwogICAgICB2YXIga3B4ckFyciA9IFtdOwogICAgICB2YXIga3B5ckFyciA9IFtdOwogICAgICB2YXIgbW9iaWxlID0gQm9vbGVhbihUeXBpbmdETkEuaXNNb2JpbGUoKSk7CiAgICAgIHZhciBkaWFncmFtVHlwZSA9IChleHRlbmRlZCA9PT0gdHJ1ZSkgPyAxIDogMDsKICAgICAgdmFyIHN0YWNrRGlhZ3JhbSA9IHRoaXMuc3RhY2tEaWFncmFtOwogICAgICB2YXIgZWxlbWVudCA9IHt9OwogICAgICBpZiAodGFyZ2V0SWQgIT09IHVuZGVmaW5lZCAmJiB0YXJnZXRJZCAhPT0gIiIgJiYgc3RhY2tEaWFncmFtLmxlbmd0aCA+IDApIHsKICAgICAgICBzdGFja0RpYWdyYW0gPSBUeXBpbmdETkEuc2xpY2VTdGFja0J5VGFyZ2V0SWQoc3RhY2tEaWFncmFtLCB0YXJnZXRJZCk7CiAgICAgICAgaWYgKHN0ciA9PT0gdW5kZWZpbmVkIHx8IHN0ciA9PT0gIiIpIHsKICAgICAgICAgIGVsZW1lbnQgPSBUeXBpbmdETkEuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGFyZ2V0SWQpOwogICAgICAgICAgaWYgKGVsZW1lbnQgIT0gbnVsbCkgewogICAgICAgICAgICBzdHIgPSBlbGVtZW50LnZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdGFyZ2V0TGVuZ3RoID0gVHlwaW5nRE5BLnRhcmdldElkcy5sZW5ndGg7CiAgICAgICAgaWYgKHN0ciA9PT0gdW5kZWZpbmVkIHx8IHN0ciA9PT0gIiIpIHsKICAgICAgICAgIGlmICh0YXJnZXRMZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHN0ciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRhcmdldExlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgZWxlbWVudCA9IFR5cGluZ0ROQS5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChUeXBpbmdETkEudGFyZ2V0SWRzW2ldKTsKICAgICAgICAgICAgICBpZiAoZWxlbWVudCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzdHIgKz0gZWxlbWVudC52YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghZXh0ZW5kZWQpIHsKICAgICAgICAgICAgICBjb25zb2xlLmxvZygiUGxlYXNlIHByb3ZpZGUgYSBmaXhlZCBzdHJpbmcgcGFyYW0gT1IgdXNlIHRoZSBhZGRUYXJnZXQgbWV0aG9kLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciBtaXNzaW5nQ291bnQgPSAwOwogICAgICB2YXIgZGlhZ3JhbUhpc3RvcnlMZW5ndGggPSBzdGFja0RpYWdyYW0ubGVuZ3RoOwogICAgICB2YXIgc3RyTGVuZ3RoID0gZGlhZ3JhbUhpc3RvcnlMZW5ndGg7CiAgICAgIGlmICh0eXBlb2Ygc3RyID09PSAnc3RyaW5nJykgewogICAgICAgIHN0ckxlbmd0aCA9IHN0ci5sZW5ndGg7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0ciA9PT0gJ251bWJlcicgJiYgc3RyIDwgZGlhZ3JhbUhpc3RvcnlMZW5ndGgpIHsKICAgICAgICBzdHJMZW5ndGggPSBzdHI7CiAgICAgIH0KICAgICAgdmFyIHJldHVyblRleHRJZCA9IDA7CiAgICAgIGlmICh0ZXh0SWQgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmIChpc05hTihwYXJzZUludCh0ZXh0SWQpKSkgewogICAgICAgICAgcmV0dXJuVGV4dElkID0gVHlwaW5nRE5BLm1hdGguZm52MWFIYXNoKHRleHRJZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVyblRleHRJZCA9IHBhcnNlSW50KHRleHRJZCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2Ygc3RyID09PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuVGV4dElkID0gVHlwaW5nRE5BLm1hdGguZm52MWFIYXNoKHN0cik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybkFyci5wdXNoKFtUeXBpbmdETkEuaXNNb2JpbGUoKSwgVHlwaW5nRE5BLnZlcnNpb24sIFR5cGluZ0ROQS5mbGFncywgZGlhZ3JhbVR5cGUsIHN0ckxlbmd0aCwKICAgICAgICByZXR1cm5UZXh0SWQsIFR5cGluZ0ROQS5nZXRTcGVjaWFsS2V5cygpLCBUeXBpbmdETkEuZ2V0RGV2aWNlU2lnbmF0dXJlKCksCiAgICAgIF0pOwogICAgICB2YXIgYXJyID0gW107CiAgICAgIHZhciBrZXlDb2RlID0gMDsKICAgICAgdmFyIGNoYXJDb2RlID0gMDsKICAgICAgdmFyIHNlZWtUaW1lID0gMDsKICAgICAgdmFyIHByZXNzVGltZSA9IDA7CiAgICAgIGlmIChzdHIgIT09IHVuZGVmaW5lZCAmJiBzdHIubGVuZ3RoID4gMCAmJiB0eXBlb2Ygc3RyID09PSAnc3RyaW5nJykgewogICAgICAgIHZhciBzdHJMb3dlciA9IHN0ci50b0xvd2VyQ2FzZSgpOwogICAgICAgIHZhciBzdHJVcHBlciA9IHN0ci50b1VwcGVyQ2FzZSgpOwogICAgICAgIHZhciBsYXN0Rm91bmRQb3MgPSBbXTsKICAgICAgICB2YXIgbGFzdFBvcyA9IDA7CiAgICAgICAgdmFyIHN0clVwcGVyQ2hhckNvZGU7CiAgICAgICAgdmFyIGN1cnJlbnRTZW5zaXRpdmVDaGFyQ29kZTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VycmVudENoYXJDb2RlID0gc3RyLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICBpZiAoIWNhc2VTZW5zaXRpdmUpIHsKICAgICAgICAgICAgc3RyVXBwZXJDaGFyQ29kZSA9IHN0clVwcGVyLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgIGN1cnJlbnRTZW5zaXRpdmVDaGFyQ29kZSA9IChzdHJVcHBlckNoYXJDb2RlICE9PSBjdXJyZW50Q2hhckNvZGUpID8gc3RyVXBwZXJDaGFyQ29kZSA6IHN0ckxvd2VyLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhcnRQb3MgPSBsYXN0UG9zOwogICAgICAgICAgdmFyIGZpbmlzaFBvcyA9IGRpYWdyYW1IaXN0b3J5TGVuZ3RoOwogICAgICAgICAgdmFyIGZvdW5kID0gZmFsc2U7CiAgICAgICAgICB3aGlsZSAoZm91bmQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGogPSBzdGFydFBvczsgaiA8IGZpbmlzaFBvczsgaisrKSB7CiAgICAgICAgICAgICAgYXJyID0gc3RhY2tEaWFncmFtW2pdOwogICAgICAgICAgICAgIGNoYXJDb2RlID0gYXJyWzNdOwogICAgICAgICAgICAgIGlmIChjaGFyQ29kZSA9PT0gY3VycmVudENoYXJDb2RlIHx8ICghY2FzZVNlbnNpdGl2ZSAmJiBjaGFyQ29kZSA9PT0gY3VycmVudFNlbnNpdGl2ZUNoYXJDb2RlKSkgewogICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGogPT09IGxhc3RQb3MpIHsKICAgICAgICAgICAgICAgICAgbGFzdFBvcysrOwogICAgICAgICAgICAgICAgICBsYXN0Rm91bmRQb3MgPSBbXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGxhc3RGb3VuZFBvcy5wdXNoKGopOwogICAgICAgICAgICAgICAgICB2YXIgbGVuID0gbGFzdEZvdW5kUG9zLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgaWYgKGxlbiA+IDEgJiYgbGFzdEZvdW5kUG9zW2xlbiAtIDFdID09PSBsYXN0Rm91bmRQb3NbbGVuIC0gMl0gKyAxKSB7CiAgICAgICAgICAgICAgICAgICAgbGFzdFBvcyA9IGogKyAxOwogICAgICAgICAgICAgICAgICAgIGxhc3RGb3VuZFBvcyA9IFtdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBrZXlDb2RlID0gYXJyWzBdOwogICAgICAgICAgICAgICAgc2Vla1RpbWUgPSBhcnJbMV07CiAgICAgICAgICAgICAgICBwcmVzc1RpbWUgPSBhcnJbMl07CiAgICAgICAgICAgICAgICBpZiAoZXh0ZW5kZWQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuQXJyLnB1c2goW2NoYXJDb2RlLCBzZWVrVGltZSwgcHJlc3NUaW1lLCBrZXlDb2RlLF0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuQXJyLnB1c2goW3NlZWtUaW1lLCBwcmVzc1RpbWUsXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobW9iaWxlID09PSB0cnVlICYmIGFycls2XSAhPT0gdW5kZWZpbmVkICYmIGFycls2XS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgIGlmIChUeXBpbmdETkEuaGFzRGV2aWNlTW90aW9uICYmIFR5cGluZ0ROQS5oYXNEZXZpY2VPcmllbnRhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGlmIChUeXBpbmdETkEubW90aW9uRml4ZWREYXRhID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICBtb3Rpb25BcnIucHVzaChhcnJbNl0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoVHlwaW5nRE5BLm1vdGlvbkFycmF5RGF0YSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAga3B6YUFyci5wdXNoKGFycls3XSk7CiAgICAgICAgICAgICAgICAgICAgICBrcHhyQXJyLnB1c2goYXJyWzhdKTsKICAgICAgICAgICAgICAgICAgICAgIGtweXJBcnIucHVzaChhcnJbOV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmb3VuZCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICBpZiAoc3RhcnRQb3MgIT09IDApIHsKICAgICAgICAgICAgICAgIHN0YXJ0UG9zID0gMDsKICAgICAgICAgICAgICAgIGZpbmlzaFBvcyA9IGxhc3RQb3M7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChUeXBpbmdETkEucmVwbGFjZU1pc3NpbmdLZXlzKSB7CiAgICAgICAgICAgICAgICAgIG1pc3NpbmdDb3VudCsrOwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIFR5cGluZ0ROQS5zYXZlZE1pc3NpbmdBdmdWYWx1ZXMgIT09ICdvYmplY3QnIHx8CiAgICAgICAgICAgICAgICAgICAgVHlwaW5nRE5BLnNhdmVkTWlzc2luZ0F2Z1ZhbHVlcy5oaXN0b3J5TGVuZ3RoICE9PSBkaWFncmFtSGlzdG9yeUxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHZhciBoaXN0U2t0RiA9IFR5cGluZ0ROQS5tYXRoLmZvKFR5cGluZ0ROQS5oaXN0b3J5LmdldCgwLCAic2VlayIpKTsKICAgICAgICAgICAgICAgICAgICB2YXIgaGlzdFBydEYgPSBUeXBpbmdETkEubWF0aC5mbyhUeXBpbmdETkEuaGlzdG9yeS5nZXQoMCwgInByZXNzIikpOwogICAgICAgICAgICAgICAgICAgIHNlZWtUaW1lID0gTWF0aC5yb3VuZChUeXBpbmdETkEubWF0aC5hdmcoaGlzdFNrdEYpKTsKICAgICAgICAgICAgICAgICAgICBwcmVzc1RpbWUgPSBNYXRoLnJvdW5kKFR5cGluZ0ROQS5tYXRoLmF2ZyhoaXN0UHJ0RikpOwogICAgICAgICAgICAgICAgICAgIFR5cGluZ0ROQS5zYXZlZE1pc3NpbmdBdmdWYWx1ZXMgPSB7CiAgICAgICAgICAgICAgICAgICAgICBzZWVrVGltZTogc2Vla1RpbWUsCiAgICAgICAgICAgICAgICAgICAgICBwcmVzc1RpbWU6IHByZXNzVGltZSwKICAgICAgICAgICAgICAgICAgICAgIGhpc3RvcnlMZW5ndGg6IGRpYWdyYW1IaXN0b3J5TGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2Vla1RpbWUgPSBUeXBpbmdETkEuc2F2ZWRNaXNzaW5nQXZnVmFsdWVzLnNlZWtUaW1lOwogICAgICAgICAgICAgICAgICAgIHByZXNzVGltZSA9IFR5cGluZ0ROQS5zYXZlZE1pc3NpbmdBdmdWYWx1ZXMucHJlc3NUaW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBtaXNzaW5nID0gMTsKICAgICAgICAgICAgICAgICAgaWYgKGV4dGVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuQXJyLnB1c2goW2N1cnJlbnRDaGFyQ29kZSwgc2Vla1RpbWUsIHByZXNzVGltZSwgY3VycmVudENoYXJDb2RlLCBtaXNzaW5nLF0pOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybkFyci5wdXNoKFtzZWVrVGltZSwgcHJlc3NUaW1lLCBtaXNzaW5nLF0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChtb2JpbGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoVHlwaW5nRE5BLm1vdGlvbkZpeGVkRGF0YSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgbW90aW9uQXJyLnB1c2goIiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoVHlwaW5nRE5BLm1vdGlvbkFycmF5RGF0YSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAga3B6YUFyci5wdXNoKCIiKTsKICAgICAgICAgICAgICAgICAgICAgIGtweHJBcnIucHVzaCgiIik7CiAgICAgICAgICAgICAgICAgICAgICBrcHlyQXJyLnB1c2goIiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChUeXBpbmdETkEucmVwbGFjZU1pc3NpbmdLZXlzUGVyYyA8IG1pc3NpbmdDb3VudCAqIDEwMCAvIHN0ckxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHN0YXJ0Q291bnQgPSAwOwogICAgICAgIGlmICh0eXBlb2Ygc3RyID09PSAnbnVtYmVyJykgewogICAgICAgICAgc3RhcnRDb3VudCA9IGRpYWdyYW1IaXN0b3J5TGVuZ3RoIC0gc3RyOwogICAgICAgIH0KICAgICAgICBpZiAoc3RhcnRDb3VudCA8IDApIHsKICAgICAgICAgIHN0YXJ0Q291bnQgPSAwOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSBzdGFydENvdW50OyBpIDwgZGlhZ3JhbUhpc3RvcnlMZW5ndGg7IGkrKykgewogICAgICAgICAgYXJyID0gc3RhY2tEaWFncmFtW2ldOwogICAgICAgICAga2V5Q29kZSA9IGFyclswXTsKICAgICAgICAgIHNlZWtUaW1lID0gYXJyWzFdOwogICAgICAgICAgcHJlc3NUaW1lID0gYXJyWzJdOwogICAgICAgICAgaWYgKGV4dGVuZGVkKSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0gYXJyWzNdOwogICAgICAgICAgICByZXR1cm5BcnIucHVzaChbY2hhckNvZGUsIHNlZWtUaW1lLCBwcmVzc1RpbWUsIGtleUNvZGVdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybkFyci5wdXNoKFtzZWVrVGltZSwgcHJlc3NUaW1lXSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobW9iaWxlID09PSB0cnVlICYmIGFycls2XSAhPT0gdW5kZWZpbmVkICYmIGFycls2XS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGlmIChUeXBpbmdETkEubW90aW9uRml4ZWREYXRhID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgbW90aW9uQXJyLnB1c2goYXJyWzZdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVHlwaW5nRE5BLm1vdGlvbkFycmF5RGF0YSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIGtwemFBcnIucHVzaChhcnJbN10pOwogICAgICAgICAgICAgIGtweHJBcnIucHVzaChhcnJbOF0pOwogICAgICAgICAgICAgIGtweXJBcnIucHVzaChhcnJbOV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciByZXR1cm5TdHIgPSByZXR1cm5BcnIuam9pbigifCIpOwogICAgICBpZiAobW9iaWxlID09PSB0cnVlKSB7CiAgICAgICAgaWYgKFR5cGluZ0ROQS5tb3Rpb25GaXhlZERhdGEgPT09IHRydWUpIHsKICAgICAgICAgIHJldHVyblN0ciArPSAiIyIgKyBtb3Rpb25BcnIuam9pbigifCIpOwogICAgICAgIH0KICAgICAgICBpZiAoVHlwaW5nRE5BLm1vdGlvbkFycmF5RGF0YSA9PT0gdHJ1ZSkgewogICAgICAgICAgcmV0dXJuU3RyICs9ICIjIiArIGtwemFBcnIuam9pbigifCIpOwogICAgICAgICAgcmV0dXJuU3RyICs9ICIvIiArIGtweHJBcnIuam9pbigifCIpOwogICAgICAgICAgcmV0dXJuU3RyICs9ICIvIiArIGtweXJBcnIuam9pbigifCIpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmV0dXJuU3RyOwogICAgfQoKICAgIFR5cGluZ0ROQS5zbGljZVN0YWNrQnlUYXJnZXRJZCA9IGZ1bmN0aW9uKHN0YWNrLCB0YXJnZXRJZCkgewogICAgICB2YXIgbGVuZ3RoID0gc3RhY2subGVuZ3RoOwogICAgICB2YXIgbmV3U3RhY2sgPSBbXTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGFyciA9IHN0YWNrW2ldOwogICAgICAgIGlmIChhcnJbNV0gPT09IHRhcmdldElkKSB7CiAgICAgICAgICBuZXdTdGFjay5wdXNoKGFycik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBuZXdTdGFjazsKICAgIH0KCiAgICBUeXBpbmdETkEuaGlzdG9yeS5nZXQgPSBmdW5jdGlvbihsZW5ndGgsIHR5cGUsIHRhcmdldElkKSB7CiAgICAgIHZhciBzdGFjayA9IHRoaXMuc3RhY2s7CiAgICAgIGlmICh0YXJnZXRJZCAhPT0gdW5kZWZpbmVkICYmIHRhcmdldElkICE9PSAiIiAmJiBzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgICAgc3RhY2sgPSBUeXBpbmdETkEuc2xpY2VTdGFja0J5VGFyZ2V0SWQoc3RhY2ssIHRhcmdldElkKTsKICAgICAgfQogICAgICB2YXIgaGlzdG9yeVRvdGFsTGVuZ3RoID0gc3RhY2subGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID09PSAwIHx8IGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgbGVuZ3RoID0gVHlwaW5nRE5BLmRlZmF1bHRIaXN0b3J5TGVuZ3RoOwogICAgICB9CiAgICAgIGlmIChsZW5ndGggPiBoaXN0b3J5VG90YWxMZW5ndGgpIHsKICAgICAgICBsZW5ndGggPSBoaXN0b3J5VG90YWxMZW5ndGg7CiAgICAgIH0KICAgICAgdmFyIHNlZWtUaW1lID0gMDsKICAgICAgdmFyIHByZXNzVGltZSA9IDA7CiAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgIGNhc2UgInNlZWsiOgogICAgICAgICAgdmFyIHNlZWtBcnIgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDw9IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHNlZWtUaW1lID0gc3RhY2tbaGlzdG9yeVRvdGFsTGVuZ3RoIC0gaV1bMV07CiAgICAgICAgICAgIGlmIChzZWVrVGltZSA8PSBUeXBpbmdETkEubWF4U2Vla1RpbWUpIHsKICAgICAgICAgICAgICBzZWVrQXJyLnB1c2goc2Vla1RpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHNlZWtBcnI7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJwcmVzcyI6CiAgICAgICAgICB2YXIgcHJlc3NBcnIgPSBbXTsKICAgICAgICAgIGZvciAoaSA9IDE7IGkgPD0gbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcHJlc3NUaW1lID0gc3RhY2tbaGlzdG9yeVRvdGFsTGVuZ3RoIC0gaV1bMl07CiAgICAgICAgICAgIGlmIChwcmVzc1RpbWUgPD0gVHlwaW5nRE5BLm1heFByZXNzVGltZSkgewogICAgICAgICAgICAgIHByZXNzQXJyLnB1c2gocHJlc3NUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiBwcmVzc0FycjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB2YXIgaGlzdG9yeVN0YWNrT2JqID0ge307CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwga2V5Q29kZXNMZW47IGkrKykgewogICAgICAgICAgICBoaXN0b3J5U3RhY2tPYmpbVHlwaW5nRE5BLmtleUNvZGVzW2ldXSA9IFsKICAgICAgICAgICAgICBbXSwKICAgICAgICAgICAgICBbXSwKICAgICAgICAgICAgICBbXQogICAgICAgICAgICBdOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChpID0gMTsgaSA8PSBsZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgYXJyID0gc3RhY2tbaGlzdG9yeVRvdGFsTGVuZ3RoIC0gaV07CiAgICAgICAgICAgIHZhciBrZXlDb2RlID0gYXJyWzBdOwogICAgICAgICAgICBzZWVrVGltZSA9IGFyclsxXTsKICAgICAgICAgICAgcHJlc3NUaW1lID0gYXJyWzJdOwogICAgICAgICAgICB2YXIgcHJldktleUNvZGUgPSBhcnJbM107CiAgICAgICAgICAgIGlmIChUeXBpbmdETkEua2V5Q29kZXNPYmpba2V5Q29kZV0pIHsKICAgICAgICAgICAgICBpZiAoc2Vla1RpbWUgPD0gVHlwaW5nRE5BLm1heFNlZWtUaW1lKSB7CiAgICAgICAgICAgICAgICBoaXN0b3J5U3RhY2tPYmpba2V5Q29kZV1bMF0ucHVzaChzZWVrVGltZSk7CiAgICAgICAgICAgICAgICBpZiAocHJldktleUNvZGUgIT09IDAgJiYgVHlwaW5nRE5BLmtleUNvZGVzT2JqW3ByZXZLZXlDb2RlXSkgewogICAgICAgICAgICAgICAgICBoaXN0b3J5U3RhY2tPYmpbcHJldktleUNvZGVdWzJdLnB1c2goc2Vla1RpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJlc3NUaW1lIDw9IFR5cGluZ0ROQS5tYXhQcmVzc1RpbWUpIHsKICAgICAgICAgICAgICAgIGhpc3RvcnlTdGFja09ialtrZXlDb2RlXVsxXS5wdXNoKHByZXNzVGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIFtoaXN0b3J5U3RhY2tPYmosIGxlbmd0aF07CiAgICAgIH0KICAgIH0KCiAgICBUeXBpbmdETkEuaGlzdG9yeS5nZXRTcGVjaWFsS2V5cyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgcmV0dXJuQXJyID0gW107CiAgICAgIHZhciBsZW5ndGggPSB0aGlzLnN0YWNrLmxlbmd0aDsKICAgICAgdmFyIGhpc3RvcnlTdGFja09iaiA9IHt9OwogICAgICB2YXIgc3BLZXlDb2Rlc0xlbiA9IFR5cGluZ0ROQS5zcEtleUNvZGVzLmxlbmd0aDsKICAgICAgdmFyIGFyciA9IHt9OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNwS2V5Q29kZXNMZW47IGkrKykgewogICAgICAgIGhpc3RvcnlTdGFja09ialtUeXBpbmdETkEuc3BLZXlDb2Rlc1tpXV0gPSBbCiAgICAgICAgICBbXSwKICAgICAgICBdOwogICAgICB9CiAgICAgIGZvciAoaSA9IDE7IGkgPD0gbGVuZ3RoOyBpKyspIHsKICAgICAgICBhcnIgPSB0aGlzLnN0YWNrW2xlbmd0aCAtIGldOwogICAgICAgIGlmIChUeXBpbmdETkEuc3BLZXlDb2Rlc09ialthcnJbMF1dKSB7CiAgICAgICAgICB2YXIga2V5Q29kZSA9IGFyclswXTsKICAgICAgICAgIHZhciBwcmVzc1RpbWUgPSBhcnJbMl07CiAgICAgICAgICBpZiAocHJlc3NUaW1lIDw9IFR5cGluZ0ROQS5tYXhQcmVzc1RpbWUpIHsKICAgICAgICAgICAgaGlzdG9yeVN0YWNrT2JqW2tleUNvZGVdWzBdLnB1c2gocHJlc3NUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yIChpID0gMDsgaSA8IHNwS2V5Q29kZXNMZW47IGkrKykgewogICAgICAgIGFyciA9IFR5cGluZ0ROQS5tYXRoLmZvKGhpc3RvcnlTdGFja09ialtUeXBpbmdETkEuc3BLZXlDb2Rlc1tpXV1bMF0pOwogICAgICAgIHZhciBhcnJMZW4gPSBhcnIubGVuZ3RoOwogICAgICAgIHJldHVybkFyci5wdXNoKGFyckxlbik7CiAgICAgICAgaWYgKGFyckxlbiA+IDEpIHsKICAgICAgICAgIHJldHVybkFyci5wdXNoKE1hdGgucm91bmQoVHlwaW5nRE5BLm1hdGguYXZnKGFycikpKTsKICAgICAgICAgIHJldHVybkFyci5wdXNoKE1hdGgucm91bmQoVHlwaW5nRE5BLm1hdGguc2QoYXJyKSkpOwogICAgICAgIH0gZWxzZSBpZiAoYXJyTGVuID09PSAxKSB7CiAgICAgICAgICByZXR1cm5BcnIucHVzaChbYXJyWzBdLCAtMSxdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuQXJyLnB1c2goWy0xLCAtMSxdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIGNsaWNrc0FyckxlbiA9IFR5cGluZ0ROQS5jbGlja1RpbWVzLmxlbmd0aDsKICAgICAgcmV0dXJuQXJyLnB1c2goY2xpY2tzQXJyTGVuKTsKICAgICAgaWYgKGNsaWNrc0FyckxlbiA+IDEpIHsKICAgICAgICByZXR1cm5BcnIucHVzaChNYXRoLnJvdW5kKFR5cGluZ0ROQS5tYXRoLmF2ZyhUeXBpbmdETkEuY2xpY2tUaW1lcykpKTsKICAgICAgICByZXR1cm5BcnIucHVzaChNYXRoLnJvdW5kKFR5cGluZ0ROQS5tYXRoLnNkKFR5cGluZ0ROQS5jbGlja1RpbWVzKSkpOwogICAgICB9IGVsc2UgaWYgKGNsaWNrc0FyckxlbiA9PT0gMSkgewogICAgICAgIHJldHVybkFyci5wdXNoKFR5cGluZ0ROQS5jbGlja1RpbWVzWzBdLCAtMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuQXJyLnB1c2goWy0xLCAtMV0pOwogICAgICB9CiAgICAgIHZhciBzdG9wQXJyTGVuID0gVHlwaW5nRE5BLnN0b3BUaW1lcy5sZW5ndGg7CiAgICAgIHJldHVybkFyci5wdXNoKHN0b3BBcnJMZW4pOwogICAgICBpZiAoc3RvcEFyckxlbiA+IDEpIHsKICAgICAgICByZXR1cm5BcnIucHVzaChNYXRoLnJvdW5kKFR5cGluZ0ROQS5tYXRoLmF2ZyhUeXBpbmdETkEuc3RvcFRpbWVzKSkpOwogICAgICAgIHJldHVybkFyci5wdXNoKE1hdGgucm91bmQoVHlwaW5nRE5BLm1hdGguc2QoVHlwaW5nRE5BLnN0b3BUaW1lcykpKTsKICAgICAgfSBlbHNlIGlmIChzdG9wQXJyTGVuID09PSAxKSB7CiAgICAgICAgcmV0dXJuQXJyLnB1c2goVHlwaW5nRE5BLnN0b3BUaW1lc1swXSwgLTEpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybkFyci5wdXNoKFstMSwgLTFdKTsKICAgICAgfQogICAgICByZXR1cm4gcmV0dXJuQXJyOwogICAgfQoKICAgIFR5cGluZ0ROQS5nZXRPU0Jyb3dzZXJNb2JpbGUgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHVhID0gVHlwaW5nRE5BLnVhOwogICAgICB2YXIgcGxhdGZvcm0gPSBUeXBpbmdETkEucGxhdGZvcm07CiAgICAgIHZhciBvcmllbnRhdGlvbiA9IHNjcmVlbi5oZWlnaHQgPj0gc2NyZWVuLndpZHRoOwogICAgICB2YXIgb3MgPSAwOwogICAgICB2YXIgb3N2ZXJzaW9uID0gMDsKICAgICAgdmFyIGJyb3dzZXJUeXBlID0gMDsKICAgICAgdmFyIHZlcnNpb24gPSAwOwogICAgICB2YXIgbW9iaWxlID0gMTsKICAgICAgaWYgKC9NU0lFLy50ZXN0KHVhKSkgewogICAgICAgIGJyb3dzZXJUeXBlID0gNDsKICAgICAgICBpZiAoL0lFTW9iaWxlLy50ZXN0KHVhKSkgewogICAgICAgICAgbW9iaWxlID0gMjsKICAgICAgICB9CiAgICAgICAgaWYgKC9NU0lFIFxkK1suXVxkKy8udGVzdCh1YSkpIHsKICAgICAgICAgIHZlcnNpb24gPSAvTVNJRSBcZCtbLl1cZCsvLmV4ZWModWEpWzBdLnNwbGl0KCcgJylbMV0uc3BsaXQoJy4nKVswXTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoL0VkZ2UvLnRlc3QodWEpKSB7CiAgICAgICAgYnJvd3NlclR5cGUgPSA2OwogICAgICAgIGlmICgvRWRnZVwvW1xkXC5dKy8udGVzdCh1YSkpIHsKICAgICAgICAgIHZlcnNpb24gPSAvRWRnZVwvW1xkXC5dKy8uZXhlYyh1YSlbMF0uc3BsaXQoJy8nKVsxXS5zcGxpdCgnLicpWzBdOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICgvQ2hyb21lLy50ZXN0KHVhKSkgewogICAgICAgIGlmICgvQ3JPUy8udGVzdCh1YSkpIHsKICAgICAgICAgIHBsYXRmb3JtID0gJ0NyT1MnOwogICAgICAgIH0KICAgICAgICBicm93c2VyVHlwZSA9IDE7CiAgICAgICAgaWYgKC9DaHJvbWVcL1tcZFwuXSsvLnRlc3QodWEpKSB7CiAgICAgICAgICB2ZXJzaW9uID0gL0Nocm9tZVwvW1xkXC5dKy8uZXhlYyh1YSlbMF0uc3BsaXQoJy8nKVsxXS5zcGxpdCgnLicpWzBdOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICgvT3BlcmEvLnRlc3QodWEpKSB7CiAgICAgICAgYnJvd3NlclR5cGUgPSAzOwogICAgICAgIGlmICgvbWluaS8udGVzdCh1YSkgfHwgL01vYmlsZS8udGVzdCh1YSkpIHsKICAgICAgICAgIG1vYmlsZSA9IDI7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKC9BbmRyb2lkLy50ZXN0KHVhKSkgewogICAgICAgIGJyb3dzZXJUeXBlID0gNzsKICAgICAgICBtb2JpbGUgPSAyOwogICAgICAgIG9zID0gNjsKICAgICAgfSBlbHNlIGlmICgvRmlyZWZveC8udGVzdCh1YSkpIHsKICAgICAgICBicm93c2VyVHlwZSA9IDI7CiAgICAgICAgaWYgKC9GZW5uZWMvLnRlc3QodWEpKSB7CiAgICAgICAgICBtb2JpbGUgPSAyOwogICAgICAgIH0KICAgICAgICBpZiAoL0ZpcmVmb3hcL1tcLlxkXSsvLnRlc3QodWEpKSB7CiAgICAgICAgICB2ZXJzaW9uID0gL0ZpcmVmb3hcL1tcLlxkXSsvLmV4ZWModWEpWzBdLnNwbGl0KCcvJylbMV0uc3BsaXQoJy4nKVswXTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoL1NhZmFyaS8udGVzdCh1YSkpIHsKICAgICAgICBicm93c2VyVHlwZSA9IDU7CiAgICAgICAgaWYgKCgvaVBob25lLy50ZXN0KHVhKSkgfHwgKC9pUGFkLy50ZXN0KHVhKSkgfHwgKC9pUG9kLy50ZXN0KHVhKSkpIHsKICAgICAgICAgIG9zID0gNTsKICAgICAgICAgIGlmICgvaVBhZC8udGVzdCh1YSkpIHsKICAgICAgICAgICAgbW9iaWxlID0gMzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1vYmlsZSA9IDI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghdmVyc2lvbikgewogICAgICAgIGlmICgvVmVyc2lvblwvW1wuXGRdKy8udGVzdCh1YSkpIHsKICAgICAgICAgIHZlcnNpb24gPSAvVmVyc2lvblwvW1wuXGRdKy8uZXhlYyh1YSk7CiAgICAgICAgfQogICAgICAgIGlmICh2ZXJzaW9uKSB7CiAgICAgICAgICB2ZXJzaW9uID0gdmVyc2lvblswXS5zcGxpdCgnLycpWzFdLnNwbGl0KCcuJylbMF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICgvT3BlcmFcL1tcLlxkXSsvLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHZlcnNpb24gPSAvT3BlcmFcL1tcLlxkXSsvLmV4ZWModWEpWzBdLnNwbGl0KCcvJylbMV0uc3BsaXQoJy4nKVswXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHBsYXRmb3JtID09PSAnTWFjSW50ZWwnIHx8IHBsYXRmb3JtID09PSAnTWFjUFBDJykgewogICAgICAgIG9zID0gMjsKICAgICAgICBpZiAoLzEwW1wuXF9cZF0rLy50ZXN0KHVhKSkgewogICAgICAgICAgb3N2ZXJzaW9uID0gLzEwW1wuXF9cZF0rLy5leGVjKHVhKVswXS5zcGxpdCgnLicsIDIpLmpvaW4oJycpOwogICAgICAgIH0KICAgICAgICBpZiAoL1tcX10vLnRlc3Qob3N2ZXJzaW9uKSkgewogICAgICAgICAgb3N2ZXJzaW9uID0gb3N2ZXJzaW9uLnNwbGl0KCdfJykuc2xpY2UoMCwgMikuam9pbignJyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHBsYXRmb3JtID09PSAnQ3JPUycpIHsKICAgICAgICBvcyA9IDQ7CiAgICAgIH0gZWxzZSBpZiAocGxhdGZvcm0gPT09ICdXaW4zMicgfHwgcGxhdGZvcm0gPT09ICdXaW42NCcpIHsKICAgICAgICBvcyA9IDE7CiAgICAgIH0gZWxzZSBpZiAoIW9zICYmIC9BbmRyb2lkLy50ZXN0KHVhKSkgewogICAgICAgIG9zID0gNjsKICAgICAgfSBlbHNlIGlmICghb3MgJiYgL0xpbnV4Ly50ZXN0KHBsYXRmb3JtKSkgewogICAgICAgIG9zID0gMzsKICAgICAgfSBlbHNlIGlmICghb3MgJiYgL1dpbmRvd3MvLnRlc3QodWEpKSB7CiAgICAgICAgb3MgPSAxOwogICAgICB9CiAgICAgIGlmICgobW9iaWxlICE9PSAzIHx8IG1vYmlsZSA9PT0gMikgJiYgVHlwaW5nRE5BLmlzTW9iaWxlKCkgPT09IDEpIHsKICAgICAgICBpZiAoLyhpcGFkfHRhYmxldHwoYW5kcm9pZCg/IS4qbW9iaWxlKSl8KHdpbmRvd3MoPyEuKnBob25lKSguKnRvdWNoKSl8a2luZGxlfHBsYXlib29rfHNpbGt8KHB1ZmZpbig/IS4qKElQfEFQfFdQKSkpKS9pLnRlc3QodWEpKSB7CiAgICAgICAgICBtb2JpbGUgPSAzOwogICAgICAgIH0gZWxzZSBpZiAoKG9zID09PSA2IHx8IG9zID09PSAwKSAmJiAoKG9yaWVudGF0aW9uICYmIHNjcmVlbi5oZWlnaHQgPiA3NjcgJiYgc2NyZWVuLndpZHRoID4gNDgwKSB8fAogICAgICAgICAgKCFvcmllbnRhdGlvbiAmJiBzY3JlZW4ud2lkdGggPiA3NjcgJiYgc2NyZWVuLmhlaWdodCA+IDQ4MCkpKSB7CiAgICAgICAgICBtb2JpbGUgPSAzOwogICAgICAgIH0gZWxzZSBpZiAob3MgPT09IDEpIHsKICAgICAgICAgIGlmICh3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQgJiYgbmF2aWdhdG9yLm1zTWF4VG91Y2hQb2ludHMgPiAwKSB7CiAgICAgICAgICAgIG1vYmlsZSA9IDM7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1vYmlsZSA9IDI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciBpc01vYmlsZTIgPSBOdW1iZXIoKHR5cGVvZiB3aW5kb3cub3JpZW50YXRpb24gIT09ICd1bmRlZmluZWQnKSB8fCAodWEuaW5kZXhPZignSUVNb2JpbGUnKSAhPT0gLTEpKSArIDE7CiAgICAgIHZhciBpc1RvdWNoRGV2aWNlID0gTnVtYmVyKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdyB8fCBuYXZpZ2F0b3IubWF4VG91Y2hQb2ludHMgfHwgd2luZG93LkRvY3VtZW50VG91Y2ggJiYgZG9jdW1lbnQgaW5zdGFuY2VvZiBEb2N1bWVudFRvdWNoIHx8IGZhbHNlKSArIDE7CiAgICAgIHJldHVybiBbTnVtYmVyKG9zKSwgTnVtYmVyKG9zdmVyc2lvbiksIE51bWJlcihicm93c2VyVHlwZSksIE51bWJlcih2ZXJzaW9uKSwgTnVtYmVyKG1vYmlsZSksIGlzTW9iaWxlMiwgTnVtYmVyKG9yaWVudGF0aW9uKSwgaXNUb3VjaERldmljZV07CiAgICB9CgogICAgVHlwaW5nRE5BLmdldERldmljZVNpZ25hdHVyZSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3NCcm93c2VyTW9iaWxlID0gVHlwaW5nRE5BLmdldE9TQnJvd3Nlck1vYmlsZSgpOwogICAgICB2YXIgZGV2aWNlVHlwZSA9IG9zQnJvd3Nlck1vYmlsZVs0XTsgLy8gezA6dW5rbm93biwgMTpwYywgMjpwaG9uZSwgMzp0YWJsZXR9CiAgICAgIHZhciBkZXZpY2VNb2RlbCA9IDA7IC8vIGZudjFhSGFzaCBvZiBkZXZpY2UgbWFudWZhY3R1cmVyICsgIi0iICsgbW9kZWwKICAgICAgdmFyIGRldmljZUlkID0gMDsgLy8gZm52MWFIYXNoIG9mIGRldmljZSBpZAogICAgICB2YXIgaXNNb2JpbGUgPSBvc0Jyb3dzZXJNb2JpbGVbNV07IC8vIHswOnVua25vd24sIDE6cGMsIDI6bW9iaWxlfQogICAgICB2YXIgb3BlcmF0aW5nU3lzdGVtID0gb3NCcm93c2VyTW9iaWxlWzBdOyAvLyB7MDp1bmtub3duL290aGVyLCAxOldpbmRvd3MsIDI6TWFjT1MsIDM6TGludXgsIDQ6Q2hyb21lT1MsIDU6aU9TLCA2OiBBbmRyb2lkfQogICAgICB2YXIgcHJvZ3JhbW1pbmdMYW5ndWFnZSA9IDE7IC8vIHswOnVua25vd24sIDE6SmF2YVNjcmlwdCwgMjpKYXZhLCAzOlN3aWZ0LCA0OkMrKywgNTpDIywgNjpBbmRyb2lkSmF2YX0KICAgICAgdmFyIHN5c3RlbUxhbmd1YWdlID0gVHlwaW5nRE5BLm1hdGguZm52MWFIYXNoKG5hdmlnYXRvci5sYW5ndWFnZSk7IC8vIGZudjFhSGFzaCBvZiBsYW5ndWFnZQogICAgICB2YXIgaXNUb3VjaERldmljZSA9IG9zQnJvd3Nlck1vYmlsZVs3XSAvLyB7MDp1bmtub3duLCAxOm5vLCAyOnllc30KICAgICAgdmFyIHByZXNzVHlwZSA9IFR5cGluZ0ROQS5nZXRQcmVzc1R5cGUoKTsgLy8gezA6dW5rbm93biwgMTpyZWNvcmRlZCwgMjpjYWxjdWxhdGVkLCAzOm1peGVkfQogICAgICB2YXIga2V5Ym9hcmRJbnB1dCA9IDA7IC8vIHswOnVua25vd24sIDE6a2V5Ym9hcmQsIDI6dG91Y2hzY3JlZW4sIDM6bWl4ZWR9CiAgICAgIHZhciBrZXlib2FyZFR5cGUgPSAwOyAvLyB7MDp1bmtub3duLCAxOmludGVybmFsLCAyOmV4dGVybmFsLCAzOm1peGVkfQogICAgICB2YXIgcG9pbnRlcklucHV0ID0gMDsgLy8gezA6dW5rbm93biwgMTptb3VzZSwgMjp0b3VjaHNjcmVlbiwgMzp0cmFja3BhZCwgNDpvdGhlciwgNTptaXhlZH0KICAgICAgdmFyIGJyb3dzZXJUeXBlID0gb3NCcm93c2VyTW9iaWxlWzJdOyAvLyB7MDp1bmtub3duLCAxOkNocm9tZSwgMjpGaXJlZm94LCAzOk9wZXJhLCA0OklFLCA1OiBTYWZhcmksIDY6IEVkZ2UsIDc6QW5kcm9pZFdLfQogICAgICB2YXIgZGlzcGxheVdpZHRoID0gc2NyZWVuLndpZHRoIHx8IDA7IC8vIHNjcmVlbiB3aWR0aCBpbiBwaXhlbHMKICAgICAgdmFyIGRpc3BsYXlIZWlnaHQgPSBzY3JlZW4uaGVpZ2h0IHx8IDA7IC8vIHNjcmVlbiBoZWlnaHQgaW4gcGl4ZWxzCiAgICAgIHZhciBvcmllbnRhdGlvbiA9IG9zQnJvd3Nlck1vYmlsZVs2XSA/IDEgOiAyOy8vIHswOnVua25vd24sIDE6cG9ydHJhaXQsIDI6bGFuZHNjYXBlfQogICAgICB2YXIgb3NWZXJzaW9uID0gb3NCcm93c2VyTW9iaWxlWzFdOyAvLyBudW1iZXJzIG9ubHkKICAgICAgdmFyIGJyb3dzZXJWZXJzaW9uID0gb3NCcm93c2VyTW9iaWxlWzNdOyAvLyBudW1iZXJzIG9ubHkKICAgICAgdmFyIGNvb2tpZUlkID0gVHlwaW5nRE5BLmNvb2tpZUlkOyAvLyBkZWZhdWx0IDAKICAgICAgdmFyIHNpZ25hdHVyZSA9IFR5cGluZ0ROQS5tYXRoLmZudjFhSGFzaChbZGV2aWNlVHlwZSwgZGV2aWNlTW9kZWwsIGRldmljZUlkLCBpc01vYmlsZSwgb3BlcmF0aW5nU3lzdGVtLCBwcm9ncmFtbWluZ0xhbmd1YWdlLCBzeXN0ZW1MYW5ndWFnZSwgaXNUb3VjaERldmljZSwgcHJlc3NUeXBlLAogICAgICAgIGtleWJvYXJkSW5wdXQsIGtleWJvYXJkVHlwZSwgcG9pbnRlcklucHV0LCBicm93c2VyVHlwZSwgZGlzcGxheVdpZHRoLCBkaXNwbGF5SGVpZ2h0LCBvcmllbnRhdGlvbiwgb3NWZXJzaW9uLCBicm93c2VyVmVyc2lvbiwgY29va2llSWQKICAgICAgXS5qb2luKCctJykpOyAvLyBmbnYxYUhhc2ggb2YgYWxsIGFib3ZlIQogICAgICByZXR1cm4gW2RldmljZVR5cGUsIGRldmljZU1vZGVsLCBkZXZpY2VJZCwgaXNNb2JpbGUsIG9wZXJhdGluZ1N5c3RlbSwgcHJvZ3JhbW1pbmdMYW5ndWFnZSwgc3lzdGVtTGFuZ3VhZ2UsIGlzVG91Y2hEZXZpY2UsIHByZXNzVHlwZSwKICAgICAgICBrZXlib2FyZElucHV0LCBrZXlib2FyZFR5cGUsIHBvaW50ZXJJbnB1dCwgYnJvd3NlclR5cGUsIGRpc3BsYXlXaWR0aCwgZGlzcGxheUhlaWdodCwgb3JpZW50YXRpb24sIG9zVmVyc2lvbiwgYnJvd3NlclZlcnNpb24sIGNvb2tpZUlkLCBzaWduYXR1cmUKICAgICAgXTsKICAgIH0KCiAgICBUeXBpbmdETkEuZ2V0UHJlc3NUeXBlID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChUeXBpbmdETkEuaXNNb2JpbGUoKSA9PT0gMCkgewogICAgICAgIFR5cGluZ0ROQS5wcmVzc1JlY29yZGVkID09PSB0cnVlOwogICAgICAgIHJldHVybiAxOyAvLyBkZXNrdG9wIGJyb3dzZXIgKHR5cGljYWx5KQogICAgICB9CiAgICAgIGlmIChUeXBpbmdETkEucHJlc3NDYWxjdWxhdGVkID09PSB0cnVlKSB7CiAgICAgICAgaWYgKFR5cGluZ0ROQS5wcmVzc1JlY29yZGVkID09PSB0cnVlKSB7CiAgICAgICAgICByZXR1cm4gMzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIDI7IC8vIG1vYmlsZSBicm93c2VyICh0eXBpY2FseSkKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoVHlwaW5nRE5BLnByZXNzUmVjb3JkZWQgPT09IHRydWUpIHsKICAgICAgICByZXR1cm4gMTsgLy8gbW9iaWxlIGFwcCAodHlwaWNhbHkpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIHRoZSBxdWFsaXR5IG9mIGEgdHlwaW5nIHBhdHRlcm4gdHlwZSAwLCBob3cgd2VsbCBpdCBpcyByZXZlbGF0ZWQsIGhvdyB1c2VmdWwgdGhlCiAgICAgKiBpbmZvcm1hdGlvbiB3aWxsIGJlIGZvciBtYXRjaGluZyBhcHBsaWNhdGlvbnMuIEl0IHJldHVybnMgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDEuCiAgICAgKiBWYWx1ZXMgb3ZlciAwLjMgYXJlIGFjY2VwdGFibGUsIGhvd2V2ZXIgYSB2YWx1ZSBvdmVyIDAuNyBzaG93cyBnb29kIHBhdHRlcm4gc3RyZW5ndGguCiAgICAgKiBAcGFyYW0gIHtTdHJpbmd9IHR5cGluZ1BhdHRlcm4gVGhlIHR5cGluZyBwYXR0ZXJuIHN0cmluZyByZXR1cm5lZCBieSB0aGUgZ2V0VHlwaW5nUGF0dGVybih7dHlwZTowfSkgZnVuY3Rpb24uCiAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9IEEgcmVhbCBudW1iZXIgYmV0d2VlbiAwIGFuZCAxLiBBIGNsb3NlIHRvIDEgdmFsdWUgbWVhbnMgYSBzdHJvbmdlciBwYXR0ZXJuLgogICAgICogQGV4YW1wbGUgdmFyIHF1YWxpdHkgPSB0ZG5hLmdldFF1YWxpdHkodHlwaW5nUGF0dGVybik7CiAgICAgKi8KICAgIFR5cGluZ0ROQS5nZXRRdWFsaXR5ID0gZnVuY3Rpb24odHlwaW5nUGF0dGVybikgewogICAgICB2YXIgb2JqID0gdHlwaW5nUGF0dGVybi5zcGxpdCgiLCIpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iai5sZW5ndGg7IGkrKykgewogICAgICAgIG9ialtpXSA9IE51bWJlcihvYmpbaV0pOwogICAgICB9CiAgICAgIHZhciBhY2MgPSAwOwogICAgICB2YXIgcmVjID0gMDsKICAgICAgdmFyIGF2Z0FjYyA9IDA7CiAgICAgIHZhciByZXZzID0gb2JqLnNsaWNlKDExLCA1NSk7CiAgICAgIHZhciBhdmcgPSBUeXBpbmdETkEubWF0aC5hdmcocmV2cyk7CiAgICAgIHZhciByZXZzTGVuID0gcmV2cy5sZW5ndGg7CiAgICAgIGZvciAoaSA9IDA7IGkgPCByZXZzTGVuOyBpKyspIHsKICAgICAgICByZWMgKz0gTnVtYmVyKHJldnNbaV0gPiAwKTsKICAgICAgICBhY2MgKz0gTnVtYmVyKHJldnNbaV0gPiA0KTsKICAgICAgICBhdmdBY2MgKz0gTnVtYmVyKHJldnNbaV0gPiBhdmcpOwogICAgICB9CiAgICAgIHZhciB0UmV0dXJuID0gTWF0aC5zcXJ0KHJlYyAqIGFjYyAqIGF2Z0FjYykgLyA3NTsKICAgICAgcmV0dXJuIHRSZXR1cm4gPiAxID8gMSA6IHRSZXR1cm47CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgdGhlIHZhbGlkaXR5IG9mIGEgdHlwaW5nIHBhdHRlcm4gaWYgcmVjb3JkZWQgb24gbW9iaWxlLgogICAgICogQHBhcmFtICB7U3RyaW5nfSB0eXBpbmdQYXR0ZXJuIFRoZSB0eXBpbmcgcGF0dGVybiBzdHJpbmcgcmV0dXJuZWQgYnkgdGhlIGdldFR5cGluZ1BhdHRlcm4oe3R5cGU6MH0pIGZ1bmN0aW9uLgogICAgICogQHJldHVybiB7TnVtYmVyfSBBIHJlYWwgbnVtYmVyIGJldHdlZW4gMCBhbmQgMS4gQSBudW1iZXIgbGFyZ2VyIHRoYW4gMC43IHVzdWFsbHkgbWVhbnMgYSB2YWxpZCBwYXR0ZXJuLgogICAgICogQGV4YW1wbGUgdmFyIHF1YWxpdHkgPSB0ZG5hLmNoZWNrTW9iaWxlVmFsaWRpdHkodHlwaW5nUGF0dGVybik7CiAgICAgKi8KICAgIFR5cGluZ0ROQS5jaGVja01vYmlsZVZhbGlkaXR5ID0gZnVuY3Rpb24odHlwaW5nUGF0dGVybikgewogICAgICB2YXIgb2JqID0gdHlwaW5nUGF0dGVybi5zcGxpdCgnLCcpOwogICAgICB2YXIgdG90YWxFdmVudHMgPSBvYmpbMF07CiAgICAgIGlmICh0b3RhbEV2ZW50cyA9PT0gMCkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIHZhciByZWMgPSAwOwogICAgICB2YXIgcmV2cyA9IG9iai5zbGljZSgxMSwgNTUpOwogICAgICB2YXIgcmV2c0xlbiA9IHJldnMubGVuZ3RoOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJldnNMZW47IGkrKykgewogICAgICAgIHJlYyArPSBOdW1iZXIocmV2c1tpXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlYyAvIHRvdGFsRXZlbnRzOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgbGVuZ3RoIG9mIHRoZSB0eXBpbmcgcGF0dGVybi4KICAgICAqIEBwYXJhbSAge1N0cmluZ30gdHlwaW5nUGF0dGVybiBUaGUgdHlwaW5nIHBhdHRlcm4gc3RyaW5nIHJldHVybmVkIGJ5IHRoZSBnZXQoKSBmdW5jdGlvbi4KICAgICAqIEByZXR1cm4ge051bWJlcn0gMCBpZiB0aGUgdHlwaW5nIHBhdHRlcm4gaXMgbm90IGEgdmFsaWQgcGF0dGVybi4gQSBudW1iZXIgZ3JlYXRlciB0aGFuIDAsIG90aGVyd2lzZS4KICAgICAqIEBleGFtcGxlIHZhciBsZW5ndGggPSB0ZG5hLmdldExlbmd0aCgiMCwzLjEsMCwwLDEsMTA5MTU0NTU2OCwwLC0xLC0xLDAsLTEsLTEsMCwtMSwtMSwyLDc2LDEzLDIsMTA1LDQ0LDEsMCwwLDEsMSwxLDkwMjI0ODE4MiwxMSwxLDAsMCwwLDEsMjA0OCwxMTUyLDEsMCw3NiwwLDIwNTM1MDY0MTl8MTM0MzYsMTAxIik7CiAgICAgKi8KICAgIFR5cGluZ0ROQS5nZXRMZW5ndGggPSBmdW5jdGlvbih0eXBpbmdQYXR0ZXJuKSB7CiAgICAgIGlmKHR5cGluZ1BhdHRlcm4gJiYgdHlwZW9mIHR5cGluZ1BhdHRlcm4gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdmFyIHNlcGFyYXRvckluZGV4ID0gdHlwaW5nUGF0dGVybi5pbmRleE9mKCd8Jyk7CiAgICAgICAgaWYoc2VwYXJhdG9ySW5kZXggPiAwKSB7CiAgICAgICAgICByZXR1cm4gTnVtYmVyKHR5cGluZ1BhdHRlcm4uc3Vic3RyaW5nKDAsc2VwYXJhdG9ySW5kZXgpLnNwbGl0KCcsJylbNF0pIHx8IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBOdW1iZXIodHlwaW5nUGF0dGVybi5zcGxpdCgnLCcpWzBdKSB8fCAwOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gMDsKICAgIH0KCiAgICAvKioKICAgICAqIENhbGN1bGF0ZXMgYSAzMi1iaXQgRk5WLTFhIGhhc2ggb24gdGhlIHN0cmluZyBwcm92aWRlZAogICAgICogQHBhcmFtICB7U3RyaW5nfSBzdHIgVGhlIHN0cmluZyBmb3Igd2hpY2ggdGhlIHRleHRJZCBpcyBjYWxjdWxhdGVkLiBVc3VhbGx5IHRoZSB0ZXh0IGJlaW5nIHR5cGVkLgogICAgICogQHJldHVybiB7TnVtYmVyfSBUaGUgaGFzaCBvZiB0aGUgc3RyaW5nIHByb3ZpZGVkIGFzIHBhcmFtLgogICAgICogQGV4YW1wbGUgdmFyIHRleHRJZCA9IHRkbmEuZ2V0VGV4dElkKCJJIHR5cGUgdG8gYmUgYXV0aGVudGljYXRlZCIpOwogICAgICovCiAgICBUeXBpbmdETkEuZ2V0VGV4dElkID0gZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBUeXBpbmdETkEubWF0aC5mbnYxYUhhc2goc3RyKTsKICAgIH0KICB9IGVsc2UgewogICAgLy8gVHlwaW5nRE5BIGlzIGEgc3RhdGljIGNsYXNzLCBjdXJyZW50bHkgZG9lc24ndCBzdXBwb3J0IGFjdHVhbCBtdWx0aXBsZSBpbnN0YW5jZXMgKFNpbmdsZXRvbiBpbXBsZW1lbnRhdGlvbikKICAgIHJldHVybiBUeXBpbmdETkEuaW5zdGFuY2U7CiAgfQp9",
      "default": false,
      "language": "JAVASCRIPT",
      "context": "AUTHENTICATION_CLIENT_SIDE",
      "createdBy": "null",
      "creationDate": 0,
      "lastModifiedBy": "null",
      "lastModifiedDate": 0
    }
  },
  "tree": {
    "_id": "TypingDNA-Shortphrase-ContinuousEnroll",
    "nodes": {
      "13b0504e-e6fe-4087-ae86-dc534e509aac": {
        "displayName": "Login",
        "nodeType": "PageNode",
        "connections": {
          "outcome": "90f2e5c8-7f47-4f5b-975b-9b4762c5e4e7"
        }
      },
      "44985fef-76b3-46b2-a029-9e4709cacaa1": {
        "displayName": "TypingDNA",
        "nodeType": "PageNode",
        "connections": {
          "outcome": "ec7c3bb9-9bbf-453a-928d-243dca1f5a01"
        }
      },
      "90f2e5c8-7f47-4f5b-975b-9b4762c5e4e7": {
        "displayName": "Data Store Decision",
        "nodeType": "DataStoreDecisionNode",
        "connections": {
          "false": "e301438c-0bd0-429c-ab0c-66126501069a",
          "true": "44985fef-76b3-46b2-a029-9e4709cacaa1"
        }
      },
      "ec7c3bb9-9bbf-453a-928d-243dca1f5a01": {
        "displayName": "TypingDNA Decision Node",
        "nodeType": "TypingDNADecisionNode",
        "connections": {
          "ENROLL": "70e691a5-1e33-4ac3-a356-e7b6d60d92e0",
          "RETRY": "44985fef-76b3-46b2-a029-9e4709cacaa1",
          "MATCH": "70e691a5-1e33-4ac3-a356-e7b6d60d92e0",
          "NO_MATCH": "e301438c-0bd0-429c-ab0c-66126501069a",
          "FAIL": "e301438c-0bd0-429c-ab0c-66126501069a"
        }
      }
    },
    "entryNodeId": "13b0504e-e6fe-4087-ae86-dc534e509aac"
  }
}
